<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DAMCH Teaching Faculty Leave Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
--primary:#0f4c81;--primary-light:#1a6bab;--primary-dark:#0a3459;
--accent:#e8a838;--accent-light:#f0c060;
--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;
--bg:#f0f4f8;--bg-card:#ffffff;--bg-sidebar:#0b1a2e;
--text:#1e293b;--text-light:#64748b;--text-white:#f8fafc;
--border:#e2e8f0;--shadow:0 4px 24px rgba(0,0,0,0.08);
--shadow-lg:0 12px 40px rgba(0,0,0,0.12);
--radius:12px;--radius-sm:8px;--radius-lg:16px;
--transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;min-height:100vh}

/* === SCROLLBAR === */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--primary-light);border-radius:3px}

/* === LOGIN PAGE === */
.login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;
background:linear-gradient(135deg,#0b1a2e 0%,#0f4c81 50%,#1a6bab 100%);
position:relative;overflow:hidden}
.login-page::before{content:'';position:absolute;width:600px;height:600px;
background:radial-gradient(circle,rgba(232,168,56,0.15),transparent 70%);
top:-200px;right:-200px;border-radius:50%}
.login-page::after{content:'';position:absolute;width:400px;height:400px;
background:radial-gradient(circle,rgba(26,107,171,0.2),transparent 70%);
bottom:-100px;left:-100px;border-radius:50%}
.login-container{background:rgba(255,255,255,0.97);backdrop-filter:blur(20px);
border-radius:var(--radius-lg);padding:48px 40px;width:440px;max-width:95%;
box-shadow:var(--shadow-lg);position:relative;z-index:1;
border:1px solid rgba(255,255,255,0.2)}
.login-logo{text-align:center;margin-bottom:28px}
.login-logo .college-emblem{width:80px;height:80px;
background:linear-gradient(135deg,var(--primary),var(--accent));
border-radius:50%;display:flex;align-items:center;justify-content:center;
margin:0 auto 16px;box-shadow:0 8px 24px rgba(15,76,129,0.3)}
.login-logo .college-emblem i{font-size:36px;color:#fff}
.login-logo h2{font-family:'Noto Sans Devanagari',sans-serif;font-size:17px;
color:var(--primary-dark);font-weight:700;line-height:1.5}
.login-logo h3{font-size:12px;color:var(--text-light);margin-top:4px;font-weight:500;letter-spacing:0.5px}
.login-logo .addr{font-size:11px;color:var(--text-light);margin-top:6px;line-height:1.5}
.form-group{margin-bottom:20px;position:relative}
.form-group label{display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
.form-group input,.form-group select{width:100%;padding:12px 16px 12px 44px;
border:2px solid var(--border);border-radius:var(--radius-sm);font-size:14px;
transition:var(--transition);background:#fff;color:var(--text)}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);
box-shadow:0 0 0 4px rgba(15,76,129,0.1)}
.form-group .icon{position:absolute;left:14px;top:38px;color:var(--text-light);font-size:16px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
padding:12px 24px;border:none;border-radius:var(--radius-sm);font-size:14px;
font-weight:600;cursor:pointer;transition:var(--transition);text-decoration:none}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));
color:#fff;box-shadow:0 4px 16px rgba(15,76,129,0.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(15,76,129,0.4)}
.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}
.btn-danger{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff}
.btn-warning{background:linear-gradient(135deg,var(--warning),#d97706);color:#fff}
.btn-info{background:linear-gradient(135deg,var(--info),#2563eb);color:#fff}
.btn-outline{background:transparent;border:2px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:8px 16px;font-size:12px}
.btn-lg{padding:14px 32px;font-size:16px}
.btn-block{width:100%}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.login-btn{width:100%;padding:14px;font-size:15px;font-weight:700;letter-spacing:0.5px;
margin-top:8px}
.forgot-link{text-align:center;margin-top:16px}
.forgot-link a{color:var(--primary);font-size:13px;text-decoration:none;font-weight:500}
.forgot-link a:hover{text-decoration:underline}

/* === MAIN APP LAYOUT === */
.app{display:flex;min-height:100vh;display:none}
.sidebar{width:270px;background:var(--bg-sidebar);color:var(--text-white);
display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;
transition:var(--transition);overflow-y:auto}
.sidebar-header{padding:20px;text-align:center;
border-bottom:1px solid rgba(255,255,255,0.08)}
.sidebar-header .logo-circle{width:56px;height:56px;
background:linear-gradient(135deg,var(--accent),var(--accent-light));
border-radius:50%;display:flex;align-items:center;justify-content:center;
margin:0 auto 10px;font-size:24px;color:var(--primary-dark);font-weight:800}
.sidebar-header h3{font-family:'Noto Sans Devanagari',sans-serif;font-size:13px;
font-weight:600;line-height:1.5;color:var(--text-white)}
.sidebar-header p{font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px}
.sidebar-nav{flex:1;padding:12px 0}
.nav-section{padding:8px 20px 4px;font-size:10px;font-weight:700;
color:rgba(255,255,255,0.35);letter-spacing:1.5px;text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 20px;
color:rgba(255,255,255,0.65);font-size:13px;font-weight:500;cursor:pointer;
transition:var(--transition);border-left:3px solid transparent;margin:1px 0}
.nav-item:hover{background:rgba(255,255,255,0.06);color:#fff}
.nav-item.active{background:rgba(232,168,56,0.12);color:var(--accent);
border-left-color:var(--accent)}
.nav-item i{width:20px;text-align:center;font-size:15px}
.nav-item .badge{margin-left:auto;background:var(--accent);color:var(--primary-dark);
font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
.sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,0.08)}
.user-info{display:flex;align-items:center;gap:10px}
.user-avatar{width:36px;height:36px;border-radius:50%;
background:linear-gradient(135deg,var(--accent),var(--accent-light));
display:flex;align-items:center;justify-content:center;font-size:14px;
font-weight:700;color:var(--primary-dark)}
.user-details{flex:1}
.user-details .name{font-size:13px;font-weight:600;color:#fff}
.user-details .role{font-size:10px;color:rgba(255,255,255,0.5)}

/* === MAIN CONTENT === */
.main{margin-left:270px;flex:1;min-height:100vh;display:flex;flex-direction:column}
.topbar{background:#fff;padding:16px 32px;display:flex;align-items:center;
justify-content:space-between;border-bottom:1px solid var(--border);
box-shadow:0 2px 8px rgba(0,0,0,0.04);position:sticky;top:0;z-index:50}
.topbar-left{display:flex;align-items:center;gap:16px}
.topbar-left h1{font-size:20px;font-weight:700;color:var(--primary-dark)}
.topbar-left .breadcrumb{font-size:12px;color:var(--text-light)}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-right .btn-icon{width:40px;height:40px;border-radius:50%;border:none;
background:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;
color:var(--text-light);transition:var(--transition);font-size:16px}
.topbar-right .btn-icon:hover{background:var(--primary);color:#fff}
.content{flex:1;padding:28px 32px;overflow-y:auto}
.page{display:none}
.page.active{display:block}

/* === CARDS === */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:28px}
.stat-card{background:#fff;border-radius:var(--radius);padding:24px;
box-shadow:var(--shadow);position:relative;overflow:hidden;
transition:var(--transition)}
.stat-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.stat-card:nth-child(1)::before{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
.stat-card:nth-child(2)::before{background:linear-gradient(90deg,var(--success),#059669)}
.stat-card:nth-child(3)::before{background:linear-gradient(90deg,var(--warning),#d97706)}
.stat-card:nth-child(4)::before{background:linear-gradient(90deg,var(--info),#2563eb)}
.stat-card:nth-child(5)::before{background:linear-gradient(90deg,var(--danger),#dc2626)}
.stat-card .stat-icon{width:48px;height:48px;border-radius:var(--radius-sm);
display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:16px}
.stat-card:nth-child(1) .stat-icon{background:rgba(15,76,129,0.1);color:var(--primary)}
.stat-card:nth-child(2) .stat-icon{background:rgba(16,185,129,0.1);color:var(--success)}
.stat-card:nth-child(3) .stat-icon{background:rgba(245,158,11,0.1);color:var(--warning)}
.stat-card:nth-child(4) .stat-icon{background:rgba(59,130,246,0.1);color:var(--info)}
.stat-card:nth-child(5) .stat-icon{background:rgba(239,68,68,0.1);color:var(--danger)}
.stat-card .stat-value{font-size:28px;font-weight:800;color:var(--text)}
.stat-card .stat-label{font-size:12px;color:var(--text-light);margin-top:4px;font-weight:500}

/* === CHARTS === */
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;margin-bottom:28px}
.chart-card{background:#fff;border-radius:var(--radius);padding:24px;box-shadow:var(--shadow)}
.chart-card h3{font-size:15px;font-weight:700;color:var(--text);margin-bottom:16px;
padding-bottom:12px;border-bottom:1px solid var(--border)}

/* === TABLE === */
.table-container{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.table-header{padding:20px 24px;display:flex;align-items:center;justify-content:space-between;
border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px}
.table-header h3{font-size:16px;font-weight:700;color:var(--text)}
.table-actions{display:flex;gap:8px;flex-wrap:wrap}
.search-box{position:relative}
.search-box input{padding:10px 16px 10px 40px;border:2px solid var(--border);
border-radius:var(--radius-sm);font-size:13px;width:260px;transition:var(--transition)}
.search-box input:focus{border-color:var(--primary);outline:none;
box-shadow:0 0 0 4px rgba(15,76,129,0.1)}
.search-box i{position:absolute;left:14px;top:50%;transform:translateY(-50%);
color:var(--text-light);font-size:14px}
table{width:100%;border-collapse:collapse}
th{background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:#fff;
padding:12px 16px;text-align:left;font-size:12px;font-weight:600;
letter-spacing:0.5px;text-transform:uppercase;white-space:nowrap}
td{padding:12px 16px;font-size:13px;border-bottom:1px solid var(--border);
color:var(--text);vertical-align:middle}
tr:hover td{background:rgba(15,76,129,0.02)}
.dept-badge{display:inline-block;padding:4px 10px;border-radius:20px;
font-size:11px;font-weight:600;white-space:nowrap}
.desig-badge{display:inline-block;padding:3px 10px;border-radius:4px;
font-size:11px;font-weight:600}
.desig-principal{background:#fef3c7;color:#92400e}
.desig-professor{background:#dbeafe;color:#1e40af}
.desig-reader,.desig-associate{background:#d1fae5;color:#065f46}
.desig-lecturer,.desig-assistant{background:#ede9fe;color:#5b21b6}

/* === MODAL === */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);
backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;
justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--radius-lg);width:680px;max-width:100%;
max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn 0.3s ease}
@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);
display:flex;align-items:center;justify-content:space-between;
background:linear-gradient(135deg,var(--primary-dark),var(--primary));
border-radius:var(--radius-lg) var(--radius-lg) 0 0}
.modal-header h3{font-size:17px;font-weight:700;color:#fff}
.modal-close{width:32px;height:32px;border:none;background:rgba(255,255,255,0.15);
color:#fff;border-radius:50%;cursor:pointer;font-size:16px;display:flex;
align-items:center;justify-content:center;transition:var(--transition)}
.modal-close:hover{background:rgba(255,255,255,0.3)}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);
display:flex;justify-content:flex-end;gap:10px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.form-row .form-group{margin-bottom:0}
.form-group-full{grid-column:1/-1}
.form-group textarea{width:100%;padding:10px 14px;border:2px solid var(--border);
border-radius:var(--radius-sm);font-size:14px;resize:vertical;min-height:80px}

/* === PROFILE PAGE === */
.profile-hero{background:linear-gradient(135deg,var(--primary-dark),var(--primary),var(--primary-light));
border-radius:var(--radius-lg);padding:40px;color:#fff;margin-bottom:24px;
position:relative;overflow:hidden}
.profile-hero::before{content:'';position:absolute;width:300px;height:300px;
background:radial-gradient(circle,rgba(232,168,56,0.15),transparent);
top:-100px;right:-50px;border-radius:50%}
.profile-info-grid{display:grid;grid-template-columns:120px 1fr;gap:24px;align-items:start}
.profile-photo{width:120px;height:120px;border-radius:50%;border:4px solid rgba(255,255,255,0.3);
object-fit:cover;background:#fff;display:flex;align-items:center;justify-content:center;
font-size:40px;color:var(--primary);overflow:hidden}
.profile-photo img{width:100%;height:100%;object-fit:cover}
.profile-details h2{font-size:24px;font-weight:800;margin-bottom:4px}
.profile-details .designation{font-size:14px;opacity:0.85;margin-bottom:8px}
.profile-details .dept{font-size:13px;opacity:0.7}
.profile-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.profile-card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.profile-card h4{font-size:14px;font-weight:700;color:var(--primary);margin-bottom:14px;
padding-bottom:10px;border-bottom:2px solid var(--bg)}
.profile-field{display:flex;justify-content:space-between;padding:8px 0;
border-bottom:1px solid var(--bg);font-size:13px}
.profile-field .label{color:var(--text-light);font-weight:500}
.profile-field .value{font-weight:600;color:var(--text);text-align:right}

/* === TOAST === */
.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;
flex-direction:column;gap:8px}
.toast{padding:14px 20px;border-radius:var(--radius-sm);color:#fff;font-size:13px;
font-weight:500;display:flex;align-items:center;gap:10px;
animation:toastIn 0.3s ease;min-width:300px;box-shadow:var(--shadow-lg)}
.toast-success{background:linear-gradient(135deg,var(--success),#059669)}
.toast-error{background:linear-gradient(135deg,var(--danger),#dc2626)}
.toast-info{background:linear-gradient(135deg,var(--info),#2563eb)}
@keyframes toastIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}

/* === PRINT === */
@media print{
.sidebar,.topbar,.no-print{display:none!important}
.main{margin-left:0!important}
.content{padding:0!important}
body{background:#fff}
.stat-card,.chart-card,.table-container,.profile-hero,.profile-card{box-shadow:none;break-inside:avoid}
.print-header{display:block!important;text-align:center;margin-bottom:20px;
padding-bottom:16px;border-bottom:2px solid #000}
.print-header h2{font-size:16px;margin-bottom:4px}
.print-header p{font-size:11px}
}
.print-header{display:none}

/* === RESPONSIVE === */
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0}
.content{padding:16px}
.form-row{grid-template-columns:1fr}
.charts-grid{grid-template-columns:1fr}
.stats-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.search-box input{width:100%}
.table-header{flex-direction:column;align-items:stretch}
.profile-info-grid{grid-template-columns:1fr;text-align:center}
.profile-photo{margin:0 auto}
}

/* === ANIMATIONS === */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.page.active{animation:fadeIn 0.4s ease}
.tag-approved{background:#d1fae5;color:#065f46;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}
.tag-pending{background:#fef3c7;color:#92400e;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}
.leave-card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:16px;
border-left:4px solid var(--primary)}
.leave-card.approved{border-left-color:var(--success)}
.leave-card.rejected{border-left-color:var(--danger)}
.leave-card.pending{border-left-color:var(--warning)}
.tab-bar{display:flex;gap:4px;margin-bottom:20px;background:#fff;padding:4px;border-radius:var(--radius-sm);box-shadow:var(--shadow)}
.tab-btn{padding:10px 20px;border:none;background:transparent;font-size:13px;font-weight:600;
color:var(--text-light);cursor:pointer;border-radius:var(--radius-sm);transition:var(--transition)}
.tab-btn.active{background:var(--primary);color:#fff}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}
.empty-state i{font-size:48px;margin-bottom:16px;opacity:0.3}
.empty-state p{font-size:14px}
select.form-select{padding:10px 14px;border:2px solid var(--border);border-radius:var(--radius-sm);
font-size:13px;background:#fff;cursor:pointer;transition:var(--transition)}
select.form-select:focus{border-color:var(--primary);outline:none}
</style>
</head>
<body>
<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage" class="login-page">
<div class="login-container">
<div class="login-logo">
<div class="college-emblem"><i class="fas fa-om"></i></div>
<h2>बाळ भगवान शिक्षण प्रसारक मंडळ, अहमदपूर</h2>
<h2>धन्वंतरी आयुर्वेद मेडिकल कॉलेज अँड<br>चॅरिटेबल हॉस्पिटल, उदगीर</h2>
<h3>TEACHING FACULTY LEAVE TRACKING SYSTEM</h3>
<p class="addr">देगलूर रोड, उदगीर - 413517, जि. लातूर, महाराष्ट्र<br>
दूरध्वनी: (02385) 259825 | Email: contact@damchudgir.edu.in</p>
</div>
<div id="loginForm">
<div class="form-group">
<label>Username</label>
<i class="fas fa-user icon"></i>
<input type="text" id="loginUser" placeholder="Enter username" autocomplete="off">
</div>
<div class="form-group">
<label>Password</label>
<i class="fas fa-lock icon"></i>
<input type="password" id="loginPass" placeholder="Enter password">
</div>
<button class="btn btn-primary login-btn" onclick="doLogin()">
<i class="fas fa-sign-in-alt"></i> Sign In
</button>
<div class="forgot-link"><a href="#" onclick="showForgot()">Forgot Password?</a></div>
</div>
<div id="forgotForm" style="display:none">
<div class="form-group">
<label>Username</label>
<i class="fas fa-user icon"></i>
<input type="text" id="forgotUser" placeholder="Your username">
</div>
<div class="form-group">
<label>Security Question: What is your favourite sport?</label>
<i class="fas fa-shield-alt icon"></i>
<input type="text" id="forgotAnswer" placeholder="Answer">
</div>
<button class="btn btn-primary login-btn" onclick="doForgotPassword()">
<i class="fas fa-key"></i> Recover Password
</button>
<div class="forgot-link"><a href="#" onclick="hideForgot()">← Back to Login</a></div>
</div>
<div style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
<p style="font-size:11px;color:var(--text-light)">Designed & Developed by <strong>Dr. Jadhav V.R.</strong> | Contact: 95183 56305</p>
<p style="font-size:10px;color:var(--text-light);margin-top:4px">© 2025-2027 | www.damchudgir.edu.in</p>
</div>
</div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="app" class="app">
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<div class="logo-circle">DA</div>
<h3>धन्वंतरी आयुर्वेद मे. कॉ.</h3>
<p>Faculty Leave Tracker</p>
</div>
<nav class="sidebar-nav" id="sidebarNav"></nav>
<div class="sidebar-footer">
<div class="user-info">
<div class="user-avatar" id="avatarInitial">A</div>
<div class="user-details">
<div class="name" id="sidebarUserName">Admin</div>
<div class="role" id="sidebarUserRole">Administrator</div>
</div>
<button class="btn-icon" onclick="doLogout()" title="Logout" style="background:rgba(255,255,255,0.08);border:none;color:rgba(255,255,255,0.6);cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center">
<i class="fas fa-sign-out-alt"></i>
</button>
</div>
</div>
</aside>

<!-- MAIN CONTENT -->
<div class="main">
<header class="topbar">
<div class="topbar-left">
<button class="btn-icon" onclick="toggleSidebar()" style="display:none" id="menuBtn">
<i class="fas fa-bars"></i>
</button>
<div>
<h1 id="pageTitle">Dashboard</h1>
<div class="breadcrumb" id="breadcrumb">Home / Dashboard</div>
</div>
</div>
<div class="topbar-right no-print">
<button class="btn-icon" onclick="window.print()" title="Print"><i class="fas fa-print"></i></button>
<button class="btn-icon" onclick="doLogout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
</div>
</header>
<div class="content" id="contentArea">
<!-- Print Header -->
<div class="print-header">
<h2>धन्वंतरी आयुर्वेद मेडिकल कॉलेज अँड चॅरिटेबल हॉस्पिटल, उदगीर</h2>
<p>देगलूर रोड, उदगीर - 413517, जि. लातूर | दूरध्वनी: (02385) 259825</p>
</div>
<!-- Pages injected by JS -->
</div>
</div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal" id="modalContent"></div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>
<script>
/* ======== CONSTANTS ======== */
const DEPTS=[
'Samhita Siddhant','Sharir Rachana','Kriya Sharir','Dravyaguna Vidnyan',
'Rasashastra B.K.','Rognidan V.V.','Swasthavritta','Agadtantra V.A.',
'Prasuti & Striroga','Kaumarbhritya','Kayachikitsa','Shalyatantra',
'Shalakya Tantra','Panchakarma'];
const DEPT_COLORS=['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899',
'#14b8a6','#f97316','#6366f1','#84cc16','#06b6d4','#d946ef','#0ea5e9','#eab308'];
const DESIG_ORDER={'Principal':0,'Professor':1,'Reader':2,'Associate Professor':2,
'Lecturer':3,'Assistant Professor':3};
const LEAVE_TYPES=['CL','ML','OD','EL','Maternity','Paternity','Study Leave',
'Sabbatical','RH','LWP','Late Mark'];
const YEARS=[2025,2026,2027];

/* ======== DEFAULT FACULTY DATA ======== */
const DEFAULT_FACULTY=[
{id:'F001',name:'Vd. Patil Dattatraya Vinayakrao',code:'AYSS00481',designation:'Professor',dept:'Samhita Siddhant',email:'hnsdvp10@gmail.com',phone:'9422819195',doj:'2003-12-23',dob:'1977-05-05',approved:'Yes',isPrincipal:true,status:'active'},
{id:'F002',name:'Vd. Khandilkar Sandeep Subhashrao',code:'AYSS00625',designation:'Professor',dept:'Samhita Siddhant',email:'sandeep.khandalikar@gmail.com',phone:'9860355409',doj:'2010-06-15',dob:'1978-03-12',approved:'Yes',status:'active'},
{id:'F003',name:'Vda. Kulkarni Neha Madhukarrao',code:'AYSS02080',designation:'Lecturer',dept:'Samhita Siddhant',email:'drnehakulkarni19@gmail.com',phone:'7498686401',doj:'2022-07-01',dob:'1994-08-19',approved:'No',status:'active'},
{id:'F004',name:'Vda. Tarde Ketaki Rangnath',code:'AYSS02196',designation:'Lecturer',dept:'Samhita Siddhant',email:'ketakitarde65856@gmail.com',phone:'9284782954',doj:'2023-01-15',dob:'1996-06-05',approved:'No',status:'active'},
{id:'F005',name:'Vda. Patil Shivani Tanajirao',code:'AYSS02244',designation:'Lecturer',dept:'Samhita Siddhant',email:'shivanipatil26896@gmail.com',phone:'8857013868',doj:'2023-06-01',dob:'1997-08-26',approved:'No',status:'active'},
{id:'F006',name:'Vd. Biradar Prashant Trembakrao',code:'AYSN00048',designation:'Lecturer',dept:'Samhita Siddhant',email:'drptbiradar14.pb@gmail.com',phone:'9970635452',doj:'2019-08-01',dob:'1990-01-14',approved:'No',status:'active'},
{id:'F007',name:'Vda. Bhandare Alka Kishanrao',code:'AYRS0408',designation:'Professor',dept:'Sharir Rachana',email:'bakreader_10@rediffmail.com',phone:'9834257911',doj:'2014-10-01',dob:'1975-11-20',approved:'Yes',status:'active'},
{id:'F008',name:'Vda. Thakur Mayuri Udaysingh',code:'AYRS00376',designation:'Reader',dept:'Sharir Rachana',email:'drmuthakur1986@gmail.com',phone:'9822086826',doj:'2016-03-01',dob:'1986-09-15',approved:'Yes',status:'active'},
{id:'F009',name:'Vd. Jadhav Vishnukant Rameshrao',code:'AYRS01211',designation:'Lecturer',dept:'Sharir Rachana',email:'jadhavvishnu696@gmail.com',phone:'9518356305',doj:'2019-11-01',dob:'1991-04-22',approved:'No',status:'active'},
{id:'F010',name:'Vda. Varnale Rakhee Gururaj',code:'AYKS00772',designation:'Reader',dept:'Kriya Sharir',email:'rakheesgowda@gmail.com',phone:'8888646429',doj:'2014-10-01',dob:'1984-07-10',approved:'Yes',status:'active'},
{id:'F011',name:'Vda. Chidre Madhumati Shivraj',code:'AYKS01029',designation:'Lecturer',dept:'Kriya Sharir',email:'madhumatichidre1010@gmail.com',phone:'9730303206',doj:'2020-01-15',dob:'1992-10-10',approved:'No',status:'active'},
{id:'F012',name:'Vda. Patange Pritee Panjabrao',code:'AYKS01382',designation:'Lecturer',dept:'Kriya Sharir',email:'drpriteepatange@gmail.com',phone:'8779314797',doj:'2022-08-01',dob:'1995-04-20',approved:'No',status:'active'},
{id:'F013',name:'Vd. Biradar Patil Swapnil Janardhan',code:'AYKS01398',designation:'Lecturer',dept:'Kriya Sharir',email:'shruteeswapnil1608@gmail.com',phone:'9049823497',doj:'2022-09-01',dob:'1996-08-16',approved:'No',status:'active'},
{id:'F014',name:'Vd. Shrigire Sayaram Ramgonda',code:'AYDG00564',designation:'Professor',dept:'Dravyaguna Vidnyan',email:'sayshrigire@gmail.com',phone:'9503870611',doj:'2008-07-01',dob:'1969-01-01',approved:'Yes',status:'active'},
{id:'F015',name:'Vda. Ghorband Shital Dattatraya',code:'AYDG01364',designation:'Reader',dept:'Dravyaguna Vidnyan',email:'vdshitaldg@gmail.com',phone:'9503288507',doj:'2018-06-01',dob:'1988-12-25',approved:'Yes',status:'active'},
{id:'F016',name:'Vda. Bharaswadkar Deepali Manikrao',code:'AYDG02228',designation:'Lecturer',dept:'Dravyaguna Vidnyan',email:'drdipali73@gmail.com',phone:'9422940175',doj:'2023-03-01',dob:'1990-07-03',approved:'No',status:'active'},
{id:'F017',name:'Vd. Kattewar Balaji Deorao',code:'AYRB00597',designation:'Professor',dept:'Rasashastra B.K.',email:'bdk73prof@gmail.com',phone:'9890125683',doj:'2007-10-01',dob:'1973-06-15',approved:'Yes',status:'active'},
{id:'F018',name:'Vd. Balutkar Pravin Dattatraya',code:'AYRB01770',designation:'Lecturer',dept:'Rasashastra B.K.',email:'vaidypravin1985@gmail.com',phone:'9028845804',doj:'2022-01-15',dob:'1985-11-20',approved:'No',status:'active'},
{id:'F019',name:'Vd. Bansode Namdev Manoharrao',code:'AYRN00325',designation:'Professor',dept:'Rognidan V.V.',email:'bansodenamdev78@gmail.com',phone:'8485816726',doj:'2019-11-02',dob:'1978-03-25',approved:'Yes',status:'active'},
{id:'F020',name:'Vda. Kore Namrata Virnath',code:'AYRN00765',designation:'Lecturer',dept:'Rognidan V.V.',email:'korenamrata123@gmail.com',phone:'9404168828',doj:'2021-06-01',dob:'1993-05-15',approved:'No',status:'active'},
{id:'F021',name:'Vd. Tale Sachinkumar Vishwanath',code:'AYSV00250',designation:'Reader',dept:'Swasthavritta',email:'sachinkumartale@gmail.com',phone:'9405048466',doj:'2014-10-01',dob:'1982-04-18',approved:'Yes',status:'active'},
{id:'F022',name:'Vda. Mulgir Kiran Devidas',code:'AYSV00947',designation:'Lecturer',dept:'Swasthavritta',email:'kiranmulgir0707@gmail.com',phone:'8482856808',doj:'2021-08-01',dob:'1994-07-07',approved:'No',status:'active'},
{id:'F023',name:'Vda. Mulajkar Shailaja Damodhar',code:'AYRB00637',designation:'Professor',dept:'Agadtantra V.A.',email:'mscherekar@gmail.com',phone:'9423776252',doj:'2010-01-15',dob:'1976-08-10',approved:'Yes',status:'active'},
{id:'F024',name:'Vd. Kadam Meera Shankarrao',code:'AYAT00650',designation:'Lecturer',dept:'Agadtantra V.A.',email:'meerakadam113@gmail.com',phone:'9673565437',doj:'2020-06-01',dob:'1990-01-13',approved:'No',status:'active'},
{id:'F025',name:'Vd. Biradar Mallikarjun Vishwanath',code:'AYAT00926',designation:'Lecturer',dept:'Agadtantra V.A.',email:'mallikarjundr1966@gmail.com',phone:'9822651995',doj:'2022-01-01',dob:'1966-07-15',approved:'No',status:'active'},
{id:'F026',name:'Vd. Bharkade Jayshree Govindrao',code:'AYAT00917',designation:'Lecturer',dept:'Agadtantra V.A.',email:'jai7g.bharkade@gmail.com',phone:'7798856306',doj:'2022-03-01',dob:'1993-07-07',approved:'No',status:'active'},
{id:'F027',name:'Vd. Mundhe Mangesh Gopinathrao',code:'AYPS00366',designation:'Professor',dept:'Prasuti & Striroga',email:'drmangeshmundhe@gmail.com',phone:'9423350673',doj:'2009-10-01',dob:'1974-06-20',approved:'Yes',status:'active'},
{id:'F028',name:'Vda. Gandge Rashmi Ramchandra',code:'AYPS00416',designation:'Reader',dept:'Prasuti & Striroga',email:'rashmichidre.rc@gmail.com',phone:'9423340006',doj:'2014-10-01',dob:'1983-12-05',approved:'Yes',status:'active'},
{id:'F029',name:'Vda. Bhadre Deepika Chhandrakant',code:'AYPS01057',designation:'Reader',dept:'Prasuti & Striroga',email:'deepikabolegave@gmail.com',phone:'9405416521',doj:'2018-01-15',dob:'1989-05-25',approved:'Yes',status:'active'},
{id:'F030',name:'Vda. Devkatte Priyanka Dnyanoba',code:'AYPS01975',designation:'Lecturer',dept:'Prasuti & Striroga',email:'pdevkate23@gmail.com',phone:'8087186702',doj:'2023-04-01',dob:'1996-03-23',approved:'No',status:'active'},
{id:'F031',name:'Vd. Mirashi Sanskruti Suraj',code:'AYKB00213',designation:'Professor',dept:'Kaumarbhritya',email:'directors@shayanagoa.com',phone:'9890052454',doj:'2012-06-01',dob:'1978-09-15',approved:'Yes',status:'active'},
{id:'F032',name:'Vda. Bhadre Asmita Ashokrao',code:'AYKB00709',designation:'Lecturer',dept:'Kaumarbhritya',email:'asmita4192@gmail.com',phone:'8408917577',doj:'2022-08-01',dob:'1992-04-01',approved:'No',status:'active'},
{id:'F033',name:'Vd. Martule Shivkumar Suryakant',code:'AYKB00725',designation:'Lecturer',dept:'Kaumarbhritya',email:'shiv1194@gmail.com',phone:'9404269871',doj:'2022-08-01',dob:'1994-11-01',approved:'No',status:'active'},
{id:'F034',name:'Vd. Biradar Shivpratap Vinayak',code:'AYKB01247',designation:'Lecturer',dept:'Kaumarbhritya',email:'biradarshivpratap@gmail.com',phone:'7517042103',doj:'2023-07-01',dob:'1997-01-15',approved:'No',status:'active'},
{id:'F035',name:'Vda. Gawale Pushpa Dagdu',code:'AYKC01184',designation:'Professor',dept:'Kayachikitsa',email:'gawalepushpa@gmail.com',phone:'9420211572',doj:'2010-10-01',dob:'1979-05-12',approved:'Yes',status:'active'},
{id:'F036',name:'Vda. Patil Snehal Gunderao',code:'AYKC01011',designation:'Reader',dept:'Kayachikitsa',email:'sneha4600@gmail.com',phone:'8600844983',doj:'2018-06-01',dob:'1988-06-04',approved:'Yes',status:'active'},
{id:'F037',name:'Vda. Chetlure Shivkanta Laxman',code:'AYKC03471',designation:'Lecturer',dept:'Kayachikitsa',email:'shivkantachetlure@gmail.com',phone:'8975362849',doj:'2022-08-01',dob:'1993-02-14',approved:'No',status:'active'},
{id:'F038',name:'Vda. Navatke Raghini Ramrao',code:'AYKC04182',designation:'Lecturer',dept:'Kayachikitsa',email:'raghini.navatke27@gmail.com',phone:'9028718443',doj:'2024-01-15',dob:'1997-07-27',approved:'No',status:'active'},
{id:'F039',name:'Vd. Mundhe Vishnukant Dnynoba',code:'AYST00603',designation:'Professor',dept:'Shalyatantra',email:'drvishnukantmundhe@gmail.com',phone:'9890271632',doj:'2009-10-01',dob:'1974-11-10',approved:'Yes',status:'active'},
{id:'F040',name:'Vd. Surnar Yogeshwar Namdev',code:'AYST00564',designation:'Reader',dept:'Shalyatantra',email:'surnaryogesh@gmail.com',phone:'8208655510',doj:'2014-10-01',dob:'1983-08-20',approved:'Yes',status:'active'},
{id:'F041',name:'Vd. Patil Amol Shivajirao',code:'AYST02412',designation:'Lecturer',dept:'Shalyatantra',email:'amolpatil523@gmail.com',phone:'9595898725',doj:'2023-01-01',dob:'1995-05-23',approved:'No',status:'active'},
{id:'F042',name:'Vda. Biradar Madhuri Suryakant',code:'AYST02720',designation:'Lecturer',dept:'Shalyatantra',email:'biradarmadhuri11@gmail.com',phone:'8496982798',doj:'2024-01-01',dob:'1996-11-11',approved:'No',status:'active'},
{id:'F043',name:'Vd. Patil Ravikant Vinayakrao',code:'AYSK00659',designation:'Professor',dept:'Shalakya Tantra',email:'rvpatil2012@gmail.com',phone:'9422610945',doj:'2008-10-01',dob:'1972-03-15',approved:'Yes',status:'active'},
{id:'F044',name:'Vd. Jamadar Pramodkumar Bibhishan',code:'AYSK01328',designation:'Lecturer',dept:'Shalakya Tantra',email:'pramodjamadar20041995@gmail.com',phone:'9096258925',doj:'2022-09-01',dob:'1995-04-20',approved:'No',status:'active'},
{id:'F045',name:'Vd. Lavate Suraj Damodar',code:'AYSK01446',designation:'Lecturer',dept:'Shalakya Tantra',email:'surajlavate18@gmail.com',phone:'8485052595',doj:'2023-03-01',dob:'1996-06-18',approved:'No',status:'active'},
{id:'F046',name:'Vd. Vansure Shivraj Shriram',code:'AYSK01538',designation:'Lecturer',dept:'Shalakya Tantra',email:'shivrajvansure20@gmail.com',phone:'7304902999',doj:'2023-08-01',dob:'1997-12-20',approved:'No',status:'active'},
{id:'F047',name:'Vd. Patane Amol Umakant',code:'AYPK00687',designation:'Professor',dept:'Panchakarma',email:'amolpatane@gmail.com',phone:'8983064943',doj:'2012-10-01',dob:'1980-04-10',approved:'Yes',status:'active'},
{id:'F048',name:'Vd. Chitte Om Virbhadra',code:'AYPK00360',designation:'Reader',dept:'Panchakarma',email:'chitteom555@gmail.com',phone:'9422653735',doj:'2014-10-01',dob:'1982-05-05',approved:'Yes',status:'active'},
{id:'F049',name:'Vda. Jagtap Prajakta Sudhakar',code:'AYPK00359',designation:'Reader',dept:'Panchakarma',email:'jagtapprajakta1808@gmail.com',phone:'9403670596',doj:'2014-10-01',dob:'1985-08-18',approved:'Yes',status:'active'},
{id:'F050',name:'Vda. Tiwari Shruti Ramchandra',code:'AYPK01561',designation:'Lecturer',dept:'Panchakarma',email:'shrutijgd18@gmail.com',phone:'7083237773',doj:'2023-05-01',dob:'1997-01-18',approved:'No',status:'active'}
];

/* ======== DB HELPERS ======== */
const DB={
  get(k){try{return JSON.parse(localStorage.getItem(k))}catch(e){return null}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v))},
  del(k){localStorage.removeItem(k)}
};

function initDB(){
  if(!DB.get('db_initialized_v7')){
    // Create users
    let users=[{username:'admin',password:'Admin@2025',role:'admin',facultyId:null,name:'Administrator',securityAnswer:'cricket'}];
    DEFAULT_FACULTY.forEach(f=>{
      users.push({username:f.code,password:'damch@'+f.code,role:'faculty',
        facultyId:f.id,name:f.name,securityAnswer:'cricket'});
    });
    DB.set('users',users);
    DB.set('faculty',JSON.parse(JSON.stringify(DEFAULT_FACULTY)));
    // Init leave data
    let leaves={};
    YEARS.forEach(y=>{leaves[y]={};
      DEFAULT_FACULTY.forEach(f=>{leaves[y][f.id]={CL:0,ML:0,OD:0,EL:0,Maternity:0,Paternity:0,'Study Leave':0,Sabbatical:0,RH:0,LWP:0,'Late Mark':0}})
    });
    DB.set('leaves',leaves);
    DB.set('leaveApplications',[]);
    DB.set('holidays',getDefaultHolidays());
    DB.set('db_initialized_v7',true);
  }
}

function getDefaultHolidays(){
  return [
    {id:'H1',date:'2025-01-14',name:'Makar Sankranti',year:2025,type:'Gazetted'},
    {id:'H2',date:'2025-01-26',name:'Republic Day',year:2025,type:'National'},
    {id:'H3',date:'2025-03-14',name:'Holi',year:2025,type:'Gazetted'},
    {id:'H4',date:'2025-04-10',name:'Ram Navami',year:2025,type:'Gazetted'},
    {id:'H5',date:'2025-04-14',name:'Dr. Ambedkar Jayanti',year:2025,type:'National'},
    {id:'H6',date:'2025-05-01',name:'Maharashtra Day',year:2025,type:'State'},
    {id:'H7',date:'2025-08-15',name:'Independence Day',year:2025,type:'National'},
    {id:'H8',date:'2025-10-02',name:'Gandhi Jayanti',year:2025,type:'National'},
    {id:'H9',date:'2025-10-20',name:'Dussehra',year:2025,type:'Gazetted'},
    {id:'H10',date:'2025-11-12',name:'Diwali',year:2025,type:'Gazetted'},
    {id:'H11',date:'2025-12-25',name:'Christmas',year:2025,type:'Gazetted'},
    {id:'H12',date:'2026-01-14',name:'Makar Sankranti',year:2026,type:'Gazetted'},
    {id:'H13',date:'2026-01-26',name:'Republic Day',year:2026,type:'National'},
    {id:'H14',date:'2026-08-15',name:'Independence Day',year:2026,type:'National'},
    {id:'H15',date:'2026-10-02',name:'Gandhi Jayanti',year:2026,type:'National'},
    {id:'H16',date:'2027-01-26',name:'Republic Day',year:2027,type:'National'},
    {id:'H17',date:'2027-08-15',name:'Independence Day',year:2027,type:'National'},
    {id:'H18',date:'2027-10-02',name:'Gandhi Jayanti',year:2027,type:'National'}
  ];
}

/* ======== SESSION ======== */
let CU=null; // current user
let CF=null; // current faculty (if faculty login)

function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value.trim();
  if(!u||!p)return toast('Please enter username and password','error');
  const users=DB.get('users')||[];
  const user=users.find(x=>x.username===u&&x.password===p);
  if(!user)return toast('Invalid username or password','error');
  CU=user;
  if(user.role==='faculty'){
    const fac=(DB.get('faculty')||[]).find(f=>f.id===user.facultyId);
    if(!fac||fac.status==='removed')return toast('Account deactivated. Contact Admin.','error');
    CF=fac;
  }
  document.getElementById('loginPage').style.display='none';
  document.getElementById('app').style.display='flex';
  buildSidebar();
  showPage('dashboard');
  toast('Welcome, '+user.name+'!','success');
}
function doLogout(){
  CU=null;CF=null;
  document.getElementById('app').style.display='none';
  document.getElementById('loginPage').style.display='flex';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
}
function showForgot(){document.getElementById('loginForm').style.display='none';document.getElementById('forgotForm').style.display='block'}
function hideForgot(){document.getElementById('loginForm').style.display='block';document.getElementById('forgotForm').style.display='none'}
function doForgotPassword(){
  const u=document.getElementById('forgotUser').value.trim();
  const a=document.getElementById('forgotAnswer').value.trim().toLowerCase();
  if(!u||!a)return toast('Fill all fields','error');
  const users=DB.get('users')||[];
  const user=users.find(x=>x.username===u);
  if(!user)return toast('Username not found','error');
  if(a!=='cricket')return toast('Incorrect security answer','error');
  alert('Your password is: '+user.password);
  hideForgot();
}
</script>
<script>
/* ======== SIDEBAR & NAVIGATION ======== */
function buildSidebar(){
  const nav=document.getElementById('sidebarNav');
  const isAdmin=CU.role==='admin';
  let html='';
  html+='<div class="nav-section">Main</div>';
  html+=navItem('dashboard','fa-th-large','Dashboard');
  if(!isAdmin){
    html+=navItem('myprofile','fa-user-circle','My Profile');
    html+=navItem('myleave','fa-calendar-check','My Leave Record');
    html+=navItem('applyleave','fa-paper-plane','Apply Leave');
  }
  html+='<div class="nav-section">Information</div>';
  html+=navItem('holidays','fa-umbrella-beach','Holidays');
  html+=navItem('policy','fa-book','Leave Policy');
  if(isAdmin){
    html+='<div class="nav-section">Administration</div>';
    html+=navItem('facultylist','fa-users','All Faculty');
    html+=navItem('managefaculty','fa-user-cog','Add / Edit / Delete Faculty');
    html+=navItem('leavetable','fa-table','Leave Master Table');
    html+=navItem('applications','fa-file-alt','Leave Applications');
    html+=navItem('manageholidays','fa-calendar-plus','Manage Holidays');
    html+=navItem('manageusers','fa-user-shield','User Management');
    html+='<div class="nav-section">Reports</div>';
    html+=navItem('reports','fa-chart-bar','Reports & Print');
    html+=navItem('backup','fa-database','Backup & Restore');
  }
  nav.innerHTML=html;
  // Update user info
  document.getElementById('sidebarUserName').textContent=CU.name;
  document.getElementById('sidebarUserRole').textContent=isAdmin?'Administrator':'Faculty';
  document.getElementById('avatarInitial').textContent=CU.name.charAt(0).toUpperCase();
  // Add click handlers
  nav.querySelectorAll('.nav-item').forEach(el=>{
    el.addEventListener('click',()=>showPage(el.dataset.page));
  });
}
function navItem(page,icon,label){
  return `<div class="nav-item" data-page="${page}"><i class="fas ${icon}"></i><span>${label}</span></div>`;
}
function showPage(page){
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.page===page));
  const titles={dashboard:'Dashboard',myprofile:'My Profile',myleave:'My Leave Record',
    applyleave:'Apply Leave',holidays:'Holiday Calendar',policy:'Leave Policy',
    facultylist:'All Faculty',managefaculty:'Manage Faculty',leavetable:'Leave Master Table',
    applications:'Leave Applications',manageholidays:'Manage Holidays',manageusers:'User Management',
    reports:'Reports & Print',backup:'Backup & Restore'};
  document.getElementById('pageTitle').textContent=titles[page]||'Dashboard';
  document.getElementById('breadcrumb').textContent='Home / '+(titles[page]||'Dashboard');
  const content=document.getElementById('contentArea');
  // Keep print header
  const ph=content.querySelector('.print-header').outerHTML;
  const pageRenderers={
    dashboard:renderDashboard, myprofile:renderMyProfile, myleave:renderMyLeave,
    applyleave:renderApplyLeave, holidays:renderHolidays, policy:renderPolicy,
    facultylist:renderFacultyList, managefaculty:renderManageFaculty,
    leavetable:renderLeaveTable, applications:renderApplications,
    manageholidays:renderManageHolidays, manageusers:renderManageUsers,
    reports:renderReports, backup:renderBackup
  };
  const renderer=pageRenderers[page];
  if(renderer){
    content.innerHTML=ph+'<div class="page active" id="pg_'+page+'"></div>';
    renderer(document.getElementById('pg_'+page));
  }
}

/* ======== UTILITY FUNCTIONS ======== */
function toast(msg,type='info'){
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className='toast toast-'+type;
  t.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i>${msg}`;
  c.appendChild(t);
  setTimeout(()=>t.remove(),4000);
}
function openModal(html){
  document.getElementById('modalContent').innerHTML=html;
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show')}
document.getElementById('modalOverlay').addEventListener('click',e=>{
  if(e.target===document.getElementById('modalOverlay'))closeModal();
});
function esc(s){if(!s)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function fmtDate(d){if(!d)return '-';const dt=new Date(d);return dt.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})}
function calcExp(doj){
  if(!doj)return '-';
  const d=new Date(doj),now=new Date();
  let y=now.getFullYear()-d.getFullYear(),m=now.getMonth()-d.getMonth();
  if(m<0){y--;m+=12}
  return y+'y '+m+'m';
}
function getActiveFaculty(){return (DB.get('faculty')||[]).filter(f=>f.status!=='removed')}
function sortFaculty(list){
  return list.sort((a,b)=>{
    const ra=(a.isPrincipal?-1:DESIG_ORDER[a.designation]??9);
    const rb=(b.isPrincipal?-1:DESIG_ORDER[b.designation]??9);
    if(ra!==rb)return ra-rb;
    // Same rank: sort by DOJ ascending (earlier = higher seniority)
    return new Date(a.doj||'9999')-new Date(b.doj||'9999');
  });
}
function deptColor(dept){const i=DEPTS.indexOf(dept);return DEPT_COLORS[i>=0?i:0]}
function genId(){return 'F'+Date.now().toString(36)+Math.random().toString(36).substr(2,4)}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open')}
</script>
<script>
/* ======== DASHBOARD ======== */
function renderDashboard(el){
  const fac=getActiveFaculty();
  const apps=DB.get('leaveApplications')||[];
  const pendingApps=apps.filter(a=>a.status==='Pending');
  const isAdmin=CU.role==='admin';
  const deptCounts={};
  DEPTS.forEach(d=>deptCounts[d]=0);
  fac.forEach(f=>{if(deptCounts[f.dept]!==undefined)deptCounts[f.dept]++});
  const desigCounts={Professor:0,Reader:0,Lecturer:0};
  fac.forEach(f=>{
    if(f.isPrincipal){desigCounts['Professor']=(desigCounts['Professor']||0)}
    if(desigCounts[f.designation]!==undefined)desigCounts[f.designation]++;
  });
  const principalCount=fac.filter(f=>f.isPrincipal).length;

  let html=`<div class="stats-grid">
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div>
      <div class="stat-value">${fac.length}</div><div class="stat-label">Total Faculty</div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-building"></i></div>
      <div class="stat-value">${DEPTS.length}</div><div class="stat-label">Departments</div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-user-tie"></i></div>
      <div class="stat-value">${desigCounts.Professor}</div><div class="stat-label">Professors</div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
      <div class="stat-value">${desigCounts.Reader}</div><div class="stat-label">Readers / Assoc. Prof.</div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-chalkboard-teacher"></i></div>
      <div class="stat-value">${desigCounts.Lecturer}</div><div class="stat-label">Lecturers / Asst. Prof.</div></div>
  </div>`;
  if(isAdmin&&pendingApps.length>0){
    html+=`<div style="background:#fef3c7;border:1px solid #fde68a;border-radius:var(--radius);padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:12px">
      <i class="fas fa-bell" style="color:#d97706;font-size:20px"></i>
      <span style="font-weight:600;color:#92400e">${pendingApps.length} pending leave application(s) awaiting review</span>
    </div>`;
  }
  html+=`<div class="charts-grid">
    <div class="chart-card"><h3><i class="fas fa-chart-bar" style="color:var(--primary);margin-right:8px"></i>Department-wise Faculty Count</h3>
      <canvas id="chartDept" height="300"></canvas></div>
    <div class="chart-card"><h3><i class="fas fa-chart-doughnut" style="color:var(--accent);margin-right:8px"></i>Designation Distribution</h3>
      <canvas id="chartDesig" height="300"></canvas></div>
  </div>`;
  html+=`<div class="charts-grid">
    <div class="chart-card"><h3><i class="fas fa-chart-pie" style="color:var(--success);margin-right:8px"></i>University Approval Status</h3>
      <canvas id="chartApproval" height="250"></canvas></div>
    <div class="chart-card"><h3><i class="fas fa-chart-line" style="color:var(--info);margin-right:8px"></i>Joining Year Trend</h3>
      <canvas id="chartJoinYear" height="250"></canvas></div>
  </div>`;
  el.innerHTML=html;
  // Charts
  setTimeout(()=>{
    // Dept chart
    new Chart(document.getElementById('chartDept'),{type:'bar',
      data:{labels:DEPTS.map(d=>d.length>15?d.substr(0,15)+'..':d),
        datasets:[{label:'Faculty',data:DEPTS.map(d=>deptCounts[d]),
          backgroundColor:DEPT_COLORS,borderRadius:6,borderSkipped:false}]},
      options:{responsive:true,plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{ticks:{maxRotation:45,font:{size:10}}}}}
    });
    // Designation chart
    new Chart(document.getElementById('chartDesig'),{type:'doughnut',
      data:{labels:['Principal','Professor','Reader/Assoc.','Lecturer/Asst.'],
        datasets:[{data:[principalCount,desigCounts.Professor-principalCount,desigCounts.Reader,desigCounts.Lecturer],
          backgroundColor:['#f59e0b','#3b82f6','#10b981','#8b5cf6'],borderWidth:0}]},
      options:{responsive:true,cutout:'60%',plugins:{legend:{position:'bottom',labels:{padding:16}}}}
    });
    // Approval chart
    const approved=fac.filter(f=>f.approved==='Yes').length;
    new Chart(document.getElementById('chartApproval'),{type:'pie',
      data:{labels:['Approved','Pending'],datasets:[{data:[approved,fac.length-approved],
        backgroundColor:['#10b981','#f59e0b'],borderWidth:0}]},
      options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });
    // Join year trend
    const joinYears={};
    fac.forEach(f=>{if(f.doj){const y=new Date(f.doj).getFullYear();joinYears[y]=(joinYears[y]||0)+1}});
    const yrs=Object.keys(joinYears).sort();
    new Chart(document.getElementById('chartJoinYear'),{type:'line',
      data:{labels:yrs,datasets:[{label:'Joinings',data:yrs.map(y=>joinYears[y]),
        borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.4,
        pointBackgroundColor:'#3b82f6',pointRadius:5}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}},plugins:{legend:{display:false}}}
    });
  },100);
}

/* ======== MY PROFILE (Faculty) ======== */
function renderMyProfile(el){
  if(!CF)return el.innerHTML='<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>No profile data</p></div>';
  const f=CF;
  el.innerHTML=`
  <div class="profile-hero">
    <div class="profile-info-grid">
      <div class="profile-photo" id="profPhoto">${f.photoData?`<img src="${f.photoData}">`:'<i class="fas fa-user"></i>'}</div>
      <div class="profile-details">
        <h2>${esc(f.name)}</h2>
        <div class="designation">${f.isPrincipal?'Principal & ':''}<span class="desig-badge desig-${f.designation.toLowerCase()}">${esc(f.designation)}</span></div>
        <div class="dept" style="margin-top:8px"><i class="fas fa-building" style="margin-right:6px"></i>${esc(f.dept)}</div>
        <div class="dept" style="margin-top:4px"><i class="fas fa-id-badge" style="margin-right:6px"></i>Teacher Code: ${esc(f.code)}</div>
      </div>
    </div>
  </div>
  <div class="profile-cards">
    <div class="profile-card">
      <h4><i class="fas fa-info-circle" style="margin-right:6px"></i>Personal Information</h4>
      <div class="profile-field"><span class="label">Date of Birth</span><span class="value">${fmtDate(f.dob)}</span></div>
      <div class="profile-field"><span class="label">Date of Joining</span><span class="value">${fmtDate(f.doj)}</span></div>
      <div class="profile-field"><span class="label">Experience</span><span class="value">${calcExp(f.doj)}</span></div>
      <div class="profile-field"><span class="label">Email</span><span class="value">${esc(f.email)}</span></div>
      <div class="profile-field"><span class="label">Phone</span><span class="value">${esc(f.phone)}</span></div>
      <div class="profile-field"><span class="label">University Approved</span><span class="value">${f.approved==='Yes'?'<span class="tag-approved">Approved</span>':'<span class="tag-pending">Pending</span>'}</span></div>
    </div>
    <div class="profile-card">
      <h4><i class="fas fa-calendar-alt" style="margin-right:6px"></i>Leave Summary (2025)</h4>
      ${renderLeaveSummaryCard(f.id,2025)}
    </div>
  </div>
  <div style="margin-top:20px">
    <button class="btn btn-primary no-print" onclick="uploadMyPhoto()"><i class="fas fa-camera"></i> Upload Photo</button>
    <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="handlePhotoUpload(this)">
  </div>`;
}
function renderLeaveSummaryCard(fid,year){
  const leaves=DB.get('leaves')||{};
  const data=(leaves[year]&&leaves[year][fid])||{};
  let html='';
  LEAVE_TYPES.forEach(lt=>{
    const v=data[lt]||0;
    if(v>0)html+=`<div class="profile-field"><span class="label">${lt}</span><span class="value" style="font-weight:700;color:${v>0?'var(--danger)':'var(--text)'};">${v}</span></div>`;
  });
  if(!html)html='<div class="profile-field"><span class="label">No leaves recorded yet</span><span class="value">✓</span></div>';
  return html;
}
function uploadMyPhoto(){document.getElementById('photoInput').click()}
function handlePhotoUpload(input){
  const file=input.files[0];if(!file)return;
  if(file.size>1048576)return toast('Photo must be under 1 MB','error');
  if(!file.type.startsWith('image/'))return toast('Only image files allowed','error');
  const reader=new FileReader();
  reader.onload=function(e){
    const fac=DB.get('faculty')||[];
    const idx=fac.findIndex(f=>f.id===CF.id);
    if(idx>=0){fac[idx].photoData=e.target.result;DB.set('faculty',fac);CF=fac[idx];
      showPage('myprofile');toast('Photo uploaded successfully','success');}
  };reader.readAsDataURL(file);
}

/* ======== MY LEAVE RECORD ======== */
function renderMyLeave(el){
  if(!CF)return;
  let html=`<div class="tab-bar">`;
  YEARS.forEach(y=>html+=`<button class="tab-btn ${y===2025?'active':''}" onclick="showLeaveYear(${y},this)">${y}</button>`);
  html+=`</div><div id="leaveYearContent"></div>`;
  el.innerHTML=html;
  showLeaveYear(2025,el.querySelector('.tab-btn.active'));
}
function showLeaveYear(year,btn){
  if(btn){btn.parentElement.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}
  const leaves=DB.get('leaves')||{};
  const data=(leaves[year]&&leaves[year][CF.id])||{};
  let total=0;Object.values(data).forEach(v=>total+=v);
  let html=`<div class="table-container"><div class="table-header"><h3>Leave Record - ${year}</h3>
    <button class="btn btn-sm btn-outline no-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button></div>
    <table><tr><th>Leave Type</th><th>Days</th></tr>`;
  LEAVE_TYPES.forEach(lt=>{const v=data[lt]||0;
    html+=`<tr><td>${lt}</td><td style="font-weight:${v>0?'700':'400'};color:${v>0?'var(--danger)':'var(--text)'}">${v}</td></tr>`});
  html+=`<tr style="background:var(--bg)"><td style="font-weight:700">Total</td><td style="font-weight:700;color:var(--danger)">${total}</td></tr>`;
  html+=`</table></div>`;
  // Also show applications
  const apps=(DB.get('leaveApplications')||[]).filter(a=>a.facultyId===CF.id&&new Date(a.fromDate).getFullYear()===year);
  if(apps.length){
    html+=`<h3 style="margin:24px 0 12px;font-size:16px">My Applications (${year})</h3>`;
    apps.forEach(a=>{
      html+=`<div class="leave-card ${a.status.toLowerCase()}">
        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px">
          <div><strong>${a.leaveType}</strong> | ${fmtDate(a.fromDate)} to ${fmtDate(a.toDate)}</div>
          <span class="desig-badge desig-${a.status==='Approved'?'professor':a.status==='Rejected'?'principal':'lecturer'}">${a.status}</span>
        </div>
        ${a.reason?'<p style="margin-top:8px;font-size:13px;color:var(--text-light)">'+esc(a.reason)+'</p>':''}
      </div>`;
    });
  }
  document.getElementById('leaveYearContent').innerHTML=html;
}

/* ======== APPLY LEAVE ======== */
function renderApplyLeave(el){
  el.innerHTML=`<div class="table-container" style="max-width:600px">
    <div class="table-header"><h3>Submit Leave Application</h3></div>
    <div style="padding:24px">
      <div class="form-row">
        <div class="form-group"><label>Leave Type</label>
          <select id="applyType" class="form-select" style="width:100%">${LEAVE_TYPES.map(lt=>'<option>'+lt+'</option>').join('')}</select></div>
        <div class="form-group"><label>Status</label><input type="text" value="Pending" readonly style="background:var(--bg);padding:10px 14px"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>From Date</label><input type="date" id="applyFrom" style="padding:10px 14px"></div>
        <div class="form-group"><label>To Date</label><input type="date" id="applyTo" style="padding:10px 14px"></div>
      </div>
      <div class="form-group"><label>Reason</label><textarea id="applyReason" placeholder="Reason for leave..."></textarea></div>
      <div class="form-group"><label>Supporting Document (PDF, max 1MB)</label>
        <input type="file" id="applyDoc" accept=".pdf" style="padding:8px"></div>
      <button class="btn btn-primary btn-block" onclick="submitLeaveApp()"><i class="fas fa-paper-plane"></i> Submit Application</button>
    </div></div>`;
}
function submitLeaveApp(){
  const type=document.getElementById('applyType').value;
  const from=document.getElementById('applyFrom').value;
  const to=document.getElementById('applyTo').value;
  const reason=document.getElementById('applyReason').value;
  if(!from||!to)return toast('Select date range','error');
  if(new Date(from)>new Date(to))return toast('From date must be before To date','error');
  const apps=DB.get('leaveApplications')||[];
  apps.push({id:'LA'+Date.now(),facultyId:CF.id,facultyName:CF.name,dept:CF.dept,
    leaveType:type,fromDate:from,toDate:to,reason:reason,status:'Pending',
    appliedOn:new Date().toISOString(),reviewedBy:null,reviewedOn:null});
  DB.set('leaveApplications',apps);
  toast('Leave application submitted successfully','success');
  showPage('myleave');
}
</script>
<script>
/* ======== HOLIDAYS ======== */
function renderHolidays(el){
  const hols=DB.get('holidays')||[];
  let html=`<div class="tab-bar">`;
  YEARS.forEach(y=>html+=`<button class="tab-btn ${y===2025?'active':''}" onclick="showHolYear(${y},this)">${y}</button>`);
  html+=`</div><div id="holContent"></div>`;
  el.innerHTML=html;
  showHolYear(2025,el.querySelector('.tab-btn.active'));
}
function showHolYear(y,btn){
  if(btn){btn.parentElement.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}
  const hols=(DB.get('holidays')||[]).filter(h=>h.year===y).sort((a,b)=>new Date(a.date)-new Date(b.date));
  let html=`<div class="table-container"><table><tr><th>#</th><th>Date</th><th>Day</th><th>Holiday Name</th><th>Type</th></tr>`;
  hols.forEach((h,i)=>{const d=new Date(h.date);
    html+=`<tr><td>${i+1}</td><td>${fmtDate(h.date)}</td><td>${d.toLocaleDateString('en-IN',{weekday:'long'})}</td>
      <td>${esc(h.name)}</td><td><span class="dept-badge" style="background:${h.type==='National'?'#dbeafe':h.type==='State'?'#d1fae5':'#fef3c7'};color:${h.type==='National'?'#1e40af':h.type==='State'?'#065f46':'#92400e'}">${h.type}</span></td></tr>`});
  html+=`</table></div>`;
  document.getElementById('holContent').innerHTML=html;
}

/* ======== LEAVE POLICY ======== */
function renderPolicy(el){
  el.innerHTML=`<div class="table-container"><div class="table-header"><h3>Leave Policy (As per MUHS / NCISM Guidelines)</h3></div>
    <div style="padding:24px;line-height:2;font-size:14px">
      <p><strong>1.</strong> Each faculty must maintain minimum <strong>75% attendance</strong> as per MUHS norms.</p>
      <p><strong>2.</strong> <strong>Casual Leave (CL):</strong> 8 days per year (cannot be carried forward).</p>
      <p><strong>3.</strong> <strong>Medical Leave (ML):</strong> As per requirement with medical certificate.</p>
      <p><strong>4.</strong> <strong>Earned Leave (EL):</strong> 30 days per year, can be carried forward up to 300 days.</p>
      <p><strong>5.</strong> <strong>Maternity Leave:</strong> 180 days (as per government norms).</p>
      <p><strong>6.</strong> <strong>Paternity Leave:</strong> 15 days.</p>
      <p><strong>7.</strong> <strong>Late Mark:</strong> 6 late marks = 1 day Casual Leave deduction (AEBS Portal).</p>
      <p><strong>8.</strong> <strong>On Duty (OD):</strong> Conferences, workshops, university work with prior approval.</p>
      <p><strong>9.</strong> <strong>Leave Without Pay (LWP):</strong> When all leave balances exhausted.</p>
      <p><strong>10.</strong> <strong>Restricted Holiday (RH):</strong> 2 days per year from the RH list.</p>
      <p style="margin-top:16px;color:var(--text-light);font-size:12px"><em>Note: This policy is effective from January 2025. Leave data is tracked from NCISM AEBs portal records.</em></p>
    </div></div>`;
}

/* ======== ALL FACULTY LIST (Admin) ======== */
function renderFacultyList(el){
  const fac=sortFaculty(getActiveFaculty());
  let html=`<div class="table-container">
    <div class="table-header"><h3>All Teaching Faculty (${fac.length})</h3>
      <div class="table-actions">
        <div class="search-box"><i class="fas fa-search"></i>
          <input type="text" placeholder="Search by name, dept, code..." onkeyup="filterFacTable(this.value)"></div>
        <select class="form-select" onchange="filterFacDept(this.value)"><option value="">All Departments</option>
          ${DEPTS.map(d=>'<option>'+d+'</option>').join('')}</select>
        <button class="btn btn-sm btn-outline" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
      </div></div>
    <div style="overflow-x:auto"><table id="facListTable"><tr><th>#</th><th>Name</th><th>Code</th><th>Designation</th><th>Department</th><th>DOJ</th><th>Exp.</th><th>Approved</th><th>Actions</th></tr>`;
  fac.forEach((f,i)=>{
    html+=`<tr data-name="${esc(f.name.toLowerCase())}" data-dept="${esc(f.dept)}" data-code="${esc(f.code.toLowerCase())}">
      <td>${i+1}</td><td style="font-weight:600">${esc(f.name)}${f.isPrincipal?' <span class="desig-badge desig-principal">Principal</span>':''}</td>
      <td><code style="font-size:11px;background:var(--bg);padding:2px 6px;border-radius:4px">${esc(f.code)}</code></td>
      <td><span class="desig-badge desig-${f.designation.toLowerCase()}">${esc(f.designation)}</span></td>
      <td><span class="dept-badge" style="background:${deptColor(f.dept)}22;color:${deptColor(f.dept)}">${esc(f.dept)}</span></td>
      <td>${fmtDate(f.doj)}</td><td>${calcExp(f.doj)}</td>
      <td>${f.approved==='Yes'?'<span class="tag-approved">Yes</span>':'<span class="tag-pending">No</span>'}</td>
      <td class="no-print"><button class="btn btn-sm btn-info" data-action="view" data-fid="${f.id}"><i class="fas fa-eye"></i></button></td></tr>`;
  });
  html+=`</table></div></div>`;
  el.innerHTML=html;
  el.querySelectorAll('[data-action="view"]').forEach(btn=>btn.addEventListener('click',()=>viewFacultyProfile(btn.dataset.fid)));
}
function filterFacTable(q){
  q=q.toLowerCase();
  document.querySelectorAll('#facListTable tr[data-name]').forEach(r=>{
    r.style.display=(r.dataset.name.includes(q)||r.dataset.code.includes(q)||r.dataset.dept.toLowerCase().includes(q))?'':'none';
  });
}
function filterFacDept(d){
  document.querySelectorAll('#facListTable tr[data-name]').forEach(r=>{
    r.style.display=(!d||r.dataset.dept===d)?'':'none';
  });
}
function viewFacultyProfile(fid){
  const f=(DB.get('faculty')||[]).find(x=>x.id===fid);if(!f)return;
  const leaves=DB.get('leaves')||{};
  openModal(`<div class="modal-header"><h3>${esc(f.name)}</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:80px 1fr;gap:16px;margin-bottom:20px">
        <div style="width:80px;height:80px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:28px;color:var(--primary);overflow:hidden">
          ${f.photoData?'<img src="'+f.photoData+'" style="width:100%;height:100%;object-fit:cover">':'<i class="fas fa-user"></i>'}</div>
        <div>
          <h3 style="font-size:18px;margin-bottom:4px">${esc(f.name)}</h3>
          <p style="color:var(--text-light);font-size:13px">${f.isPrincipal?'Principal & ':''}${esc(f.designation)} | ${esc(f.dept)}</p>
          <p style="color:var(--text-light);font-size:12px;margin-top:4px">Code: ${esc(f.code)} | Phone: ${esc(f.phone)}</p>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px">
        <div class="profile-field"><span class="label">DOB</span><span class="value">${fmtDate(f.dob)}</span></div>
        <div class="profile-field"><span class="label">DOJ</span><span class="value">${fmtDate(f.doj)}</span></div>
        <div class="profile-field"><span class="label">Experience</span><span class="value">${calcExp(f.doj)}</span></div>
        <div class="profile-field"><span class="label">Email</span><span class="value">${esc(f.email)}</span></div>
        <div class="profile-field"><span class="label">Approved</span><span class="value">${f.approved==='Yes'?'<span class="tag-approved">Yes</span>':'<span class="tag-pending">No</span>'}</span></div>
      </div>
      <h4 style="margin:20px 0 10px;font-size:14px;color:var(--primary)">Leave Summary</h4>
      ${YEARS.map(y=>{const d=(leaves[y]&&leaves[y][fid])||{};
        let total=0;Object.values(d).forEach(v=>total+=v);
        return total?`<p style="font-size:12px;margin-bottom:4px"><strong>${y}:</strong> `+LEAVE_TYPES.filter(lt=>d[lt]>0).map(lt=>lt+':'+d[lt]).join(', ')+` (Total: ${total})</p>`:'';
      }).join('')||'<p style="font-size:13px;color:var(--text-light)">No leaves recorded</p>'}
    </div>`);
}

/* ======== MANAGE FACULTY (Add/Edit/Delete) ======== */
function renderManageFaculty(el){
  const fac=sortFaculty(getActiveFaculty());
  let html=`<div class="table-container">
    <div class="table-header"><h3>Manage Faculty</h3>
      <div class="table-actions">
        <div class="search-box"><i class="fas fa-search"></i>
          <input type="text" placeholder="Search..." id="mfSearch" onkeyup="filterMF()"></div>
        <button class="btn btn-sm btn-success" onclick="addFacultyModal()"><i class="fas fa-user-plus"></i> Add Faculty</button>
      </div></div>
    <div style="overflow-x:auto"><table id="mfTable"><tr><th>#</th><th>Name</th><th>Code</th><th>Designation</th><th>Department</th><th>Actions</th></tr>`;
  fac.forEach((f,i)=>{
    html+=`<tr data-search="${esc((f.name+' '+f.code+' '+f.dept).toLowerCase())}">
      <td>${i+1}</td><td style="font-weight:600">${esc(f.name)}${f.isPrincipal?' <span class="desig-badge desig-principal">P</span>':''}</td>
      <td><code style="font-size:11px">${esc(f.code)}</code></td>
      <td><span class="desig-badge desig-${f.designation.toLowerCase()}">${esc(f.designation)}</span></td>
      <td style="font-size:12px">${esc(f.dept)}</td>
      <td class="no-print">
        <button class="btn btn-sm btn-info" data-action="edit" data-fid="${f.id}" title="Edit"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-danger" data-action="delete" data-fid="${f.id}" title="Delete"><i class="fas fa-trash"></i></button>
      </td></tr>`;
  });
  html+=`</table></div></div>`;
  el.innerHTML=html;
  el.querySelectorAll('[data-action="edit"]').forEach(b=>b.addEventListener('click',()=>editFacultyModal(b.dataset.fid)));
  el.querySelectorAll('[data-action="delete"]').forEach(b=>b.addEventListener('click',()=>deleteFaculty(b.dataset.fid)));
}
function filterMF(){
  const q=document.getElementById('mfSearch').value.toLowerCase();
  document.querySelectorAll('#mfTable tr[data-search]').forEach(r=>{
    r.style.display=r.dataset.search.includes(q)?'':'none';
  });
}
function addFacultyModal(){
  openModal(`<div class="modal-header"><h3><i class="fas fa-user-plus" style="margin-right:8px"></i>Add New Faculty</h3>
    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-group"><label>Full Name *</label><input type="text" id="af_name"></div>
        <div class="form-group"><label>Teacher Code *</label><input type="text" id="af_code"></div></div>
      <div class="form-row"><div class="form-group"><label>Designation</label>
          <select id="af_desig" class="form-select" style="width:100%"><option>Professor</option><option>Reader</option><option>Lecturer</option></select></div>
        <div class="form-group"><label>Department</label>
          <select id="af_dept" class="form-select" style="width:100%">${DEPTS.map(d=>'<option>'+d+'</option>').join('')}</select></div></div>
      <div class="form-row"><div class="form-group"><label>Date of Joining</label><input type="date" id="af_doj"></div>
        <div class="form-group"><label>Date of Birth</label><input type="date" id="af_dob"></div></div>
      <div class="form-row"><div class="form-group"><label>Email</label><input type="email" id="af_email"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="af_phone"></div></div>
      <div class="form-row"><div class="form-group"><label>University Approved</label>
          <select id="af_approved" class="form-select" style="width:100%"><option>No</option><option>Yes</option></select></div>
        <div class="form-group"><label>Is Principal?</label>
          <select id="af_principal" class="form-select" style="width:100%"><option value="false">No</option><option value="true">Yes</option></select></div></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" id="af_save"><i class="fas fa-save"></i> Save Faculty</button></div>`);
  document.getElementById('af_save').addEventListener('click',saveNewFaculty);
}
function saveNewFaculty(){
  const name=document.getElementById('af_name').value.trim();
  const code=document.getElementById('af_code').value.trim();
  if(!name||!code)return toast('Name and Teacher Code are required','error');
  const fac=DB.get('faculty')||[];
  if(fac.find(f=>f.code===code&&f.status!=='removed'))return toast('Teacher Code already exists','error');
  const id=genId();
  const newF={id,name,code,
    designation:document.getElementById('af_desig').value,
    dept:document.getElementById('af_dept').value,
    doj:document.getElementById('af_doj').value,
    dob:document.getElementById('af_dob').value,
    email:document.getElementById('af_email').value,
    phone:document.getElementById('af_phone').value,
    approved:document.getElementById('af_approved').value,
    isPrincipal:document.getElementById('af_principal').value==='true',
    status:'active'};
  fac.push(newF);DB.set('faculty',fac);
  // Create user
  const users=DB.get('users')||[];
  users.push({username:code,password:'damch@'+code,role:'faculty',facultyId:id,name:name,securityAnswer:'cricket'});
  DB.set('users',users);
  // Init leaves
  const leaves=DB.get('leaves')||{};
  YEARS.forEach(y=>{if(!leaves[y])leaves[y]={};leaves[y][id]={CL:0,ML:0,OD:0,EL:0,Maternity:0,Paternity:0,'Study Leave':0,Sabbatical:0,RH:0,LWP:0,'Late Mark':0}});
  DB.set('leaves',leaves);
  closeModal();toast('Faculty added: '+name,'success');showPage('managefaculty');
}
function editFacultyModal(fid){
  const fac=DB.get('faculty')||[];
  const f=fac.find(x=>x.id===fid);if(!f)return;
  openModal(`<div class="modal-header"><h3><i class="fas fa-edit" style="margin-right:8px"></i>Edit Faculty</h3>
    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-group"><label>Full Name</label><input type="text" id="ef_name" value="${esc(f.name)}"></div>
        <div class="form-group"><label>Teacher Code</label><input type="text" id="ef_code" value="${esc(f.code)}"></div></div>
      <div class="form-row"><div class="form-group"><label>Designation</label>
          <select id="ef_desig" class="form-select" style="width:100%">${['Professor','Reader','Lecturer'].map(d=>'<option'+(d===f.designation?' selected':'')+'>'+d+'</option>').join('')}</select></div>
        <div class="form-group"><label>Department</label>
          <select id="ef_dept" class="form-select" style="width:100%">${DEPTS.map(d=>'<option'+(d===f.dept?' selected':'')+'>'+d+'</option>').join('')}</select></div></div>
      <div class="form-row"><div class="form-group"><label>Date of Joining</label><input type="date" id="ef_doj" value="${f.doj||''}"></div>
        <div class="form-group"><label>Date of Birth</label><input type="date" id="ef_dob" value="${f.dob||''}"></div></div>
      <div class="form-row"><div class="form-group"><label>Email</label><input type="email" id="ef_email" value="${esc(f.email||'')}"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="ef_phone" value="${esc(f.phone||'')}"></div></div>
      <div class="form-row"><div class="form-group"><label>University Approved</label>
          <select id="ef_approved" class="form-select" style="width:100%"><option${f.approved==='Yes'?' selected':''}>Yes</option><option${f.approved!=='Yes'?' selected':''}>No</option></select></div>
        <div class="form-group"><label>Is Principal?</label>
          <select id="ef_principal" class="form-select" style="width:100%"><option value="true"${f.isPrincipal?' selected':''}>Yes</option><option value="false"${!f.isPrincipal?' selected':''}>No</option></select></div></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="ef_save"><i class="fas fa-save"></i> Update</button></div>`);
  document.getElementById('ef_save').addEventListener('click',()=>{
    const facs=DB.get('faculty')||[];
    const idx=facs.findIndex(x=>x.id===fid);if(idx<0)return;
    facs[idx].name=document.getElementById('ef_name').value.trim();
    facs[idx].code=document.getElementById('ef_code').value.trim();
    facs[idx].designation=document.getElementById('ef_desig').value;
    facs[idx].dept=document.getElementById('ef_dept').value;
    facs[idx].doj=document.getElementById('ef_doj').value;
    facs[idx].dob=document.getElementById('ef_dob').value;
    facs[idx].email=document.getElementById('ef_email').value;
    facs[idx].phone=document.getElementById('ef_phone').value;
    facs[idx].approved=document.getElementById('ef_approved').value;
    facs[idx].isPrincipal=document.getElementById('ef_principal').value==='true';
    DB.set('faculty',facs);
    // Update user name
    const users=DB.get('users')||[];
    const ui=users.findIndex(u=>u.facultyId===fid);
    if(ui>=0){users[ui].name=facs[idx].name;users[ui].username=facs[idx].code;DB.set('users',users)}
    closeModal();toast('Faculty updated','success');showPage('managefaculty');
  });
}
function deleteFaculty(fid){
  const fac=DB.get('faculty')||[];
  const f=fac.find(x=>x.id===fid);if(!f)return;
  if(!confirm('Delete '+f.name+'?\n\nThis will mark the faculty as removed and deactivate their login.'))return;
  const idx=fac.findIndex(x=>x.id===fid);
  fac[idx].status='removed';DB.set('faculty',fac);
  // Deactivate user
  const users=DB.get('users')||[];
  const ui=users.findIndex(u=>u.facultyId===fid);
  if(ui>=0){users.splice(ui,1);DB.set('users',users)}
  toast(f.name+' removed','success');showPage('managefaculty');
}

/* ======== LEAVE MASTER TABLE ======== */
function renderLeaveTable(el){
  const fac=sortFaculty(getActiveFaculty());
  let html=`<div class="tab-bar">`;
  YEARS.forEach(y=>html+=`<button class="tab-btn ${y===2025?'active':''}" onclick="showLT(${y},this)">${y}</button>`);
  html+=`</div><div id="ltContent"></div>`;
  el.innerHTML=html;
  showLT(2025,el.querySelector('.tab-btn.active'));
}
function showLT(year,btn){
  if(btn){btn.parentElement.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}
  const fac=sortFaculty(getActiveFaculty());
  const leaves=DB.get('leaves')||{};
  if(!leaves[year])leaves[year]={};
  let html=`<div class="table-container">
    <div class="table-header"><h3>Leave Master Table - ${year}</h3>
      <div class="table-actions">
        <select class="form-select" id="ltDeptFilter" onchange="filterLT()"><option value="">All Departments</option>${DEPTS.map(d=>'<option>'+d+'</option>').join('')}</select>
        <button class="btn btn-sm btn-success" onclick="saveLT(${year})"><i class="fas fa-save"></i> Save All</button>
        <button class="btn btn-sm btn-outline" onclick="window.print()"><i class="fas fa-print"></i></button>
      </div></div>
    <div style="overflow-x:auto"><table id="ltTable"><tr><th>#</th><th>Name</th><th>Dept</th>`;
  LEAVE_TYPES.forEach(lt=>html+=`<th style="font-size:10px">${lt}</th>`);
  html+=`<th>Total</th></tr>`;
  fac.forEach((f,i)=>{
    const d=(leaves[year]&&leaves[year][f.id])||{};
    let total=0;LEAVE_TYPES.forEach(lt=>total+=(d[lt]||0));
    html+=`<tr data-dept="${esc(f.dept)}" data-fid="${f.id}"><td>${i+1}</td><td style="font-weight:600;font-size:12px;white-space:nowrap">${esc(f.name)}</td>
      <td style="font-size:11px">${esc(f.dept)}</td>`;
    LEAVE_TYPES.forEach(lt=>{
      html+=`<td><input type="number" min="0" value="${d[lt]||0}" data-lt="${lt}" data-fid="${f.id}"
        style="width:48px;padding:4px;border:1px solid var(--border);border-radius:4px;text-align:center;font-size:12px"></td>`;
    });
    html+=`<td style="font-weight:700">${total}</td></tr>`;
  });
  html+=`</table></div></div>`;
  document.getElementById('ltContent').innerHTML=html;
}
function filterLT(){
  const d=document.getElementById('ltDeptFilter').value;
  document.querySelectorAll('#ltTable tr[data-dept]').forEach(r=>{
    r.style.display=(!d||r.dataset.dept===d)?'':'none';
  });
}
function saveLT(year){
  const leaves=DB.get('leaves')||{};
  if(!leaves[year])leaves[year]={};
  document.querySelectorAll('#ltTable input[data-lt]').forEach(inp=>{
    const fid=inp.dataset.fid,lt=inp.dataset.lt;
    if(!leaves[year][fid])leaves[year][fid]={};
    leaves[year][fid][lt]=parseInt(inp.value)||0;
  });
  DB.set('leaves',leaves);toast('Leave data saved for '+year,'success');
}

/* ======== LEAVE APPLICATIONS (Admin) ======== */
function renderApplications(el){
  const apps=(DB.get('leaveApplications')||[]).sort((a,b)=>new Date(b.appliedOn)-new Date(a.appliedOn));
  let html=`<div class="table-container"><div class="table-header"><h3>Leave Applications (${apps.length})</h3></div>
    <div style="overflow-x:auto"><table><tr><th>#</th><th>Faculty</th><th>Dept</th><th>Type</th><th>From</th><th>To</th><th>Applied</th><th>Status</th><th>Actions</th></tr>`;
  apps.forEach((a,i)=>{
    html+=`<tr><td>${i+1}</td><td style="font-weight:600">${esc(a.facultyName)}</td><td style="font-size:12px">${esc(a.dept)}</td>
      <td>${esc(a.leaveType)}</td><td>${fmtDate(a.fromDate)}</td><td>${fmtDate(a.toDate)}</td>
      <td style="font-size:12px">${fmtDate(a.appliedOn)}</td>
      <td><span class="desig-badge desig-${a.status==='Approved'?'professor':a.status==='Rejected'?'principal':'lecturer'}">${a.status}</span></td>
      <td class="no-print">${a.status==='Pending'?
        `<button class="btn btn-sm btn-success" data-action="approve" data-aid="${a.id}"><i class="fas fa-check"></i></button>
         <button class="btn btn-sm btn-danger" data-action="reject" data-aid="${a.id}"><i class="fas fa-times"></i></button>`
        :'-'}</td></tr>`;
  });
  html+=`</table></div></div>`;
  if(!apps.length)html=`<div class="empty-state"><i class="fas fa-inbox"></i><p>No leave applications yet</p></div>`;
  el.innerHTML=html;
  el.querySelectorAll('[data-action="approve"]').forEach(b=>b.addEventListener('click',()=>reviewApp(b.dataset.aid,'Approved')));
  el.querySelectorAll('[data-action="reject"]').forEach(b=>b.addEventListener('click',()=>reviewApp(b.dataset.aid,'Rejected')));
}
function reviewApp(aid,status){
  const apps=DB.get('leaveApplications')||[];
  const idx=apps.findIndex(a=>a.id===aid);if(idx<0)return;
  apps[idx].status=status;apps[idx].reviewedBy=CU.name;apps[idx].reviewedOn=new Date().toISOString();
  DB.set('leaveApplications',apps);toast('Application '+status,'success');showPage('applications');
}

/* ======== MANAGE HOLIDAYS (Admin) ======== */
function renderManageHolidays(el){
  const hols=(DB.get('holidays')||[]).sort((a,b)=>new Date(a.date)-new Date(b.date));
  let html=`<div class="table-container"><div class="table-header"><h3>Manage Holidays</h3>
      <button class="btn btn-sm btn-success" onclick="addHolidayModal()"><i class="fas fa-plus"></i> Add Holiday</button></div>
    <div style="overflow-x:auto"><table id="holTable"><tr><th>#</th><th>Date</th><th>Name</th><th>Year</th><th>Type</th><th>Actions</th></tr>`;
  hols.forEach((h,i)=>{
    html+=`<tr><td>${i+1}</td><td>${fmtDate(h.date)}</td><td>${esc(h.name)}</td><td>${h.year}</td>
      <td>${esc(h.type)}</td><td class="no-print"><button class="btn btn-sm btn-danger" data-action="delHol" data-hid="${h.id}"><i class="fas fa-trash"></i></button></td></tr>`;
  });
  html+=`</table></div></div>`;
  el.innerHTML=html;
  el.querySelectorAll('[data-action="delHol"]').forEach(b=>b.addEventListener('click',()=>{
    if(!confirm('Delete this holiday?'))return;
    let h=DB.get('holidays')||[];h=h.filter(x=>x.id!==b.dataset.hid);DB.set('holidays',h);
    toast('Holiday removed','success');showPage('manageholidays');
  }));
}
function addHolidayModal(){
  openModal(`<div class="modal-header"><h3>Add Holiday</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-group"><label>Date</label><input type="date" id="ah_date"></div>
        <div class="form-group"><label>Holiday Name</label><input type="text" id="ah_name"></div></div>
      <div class="form-row"><div class="form-group"><label>Year</label>
          <select id="ah_year" class="form-select" style="width:100%">${YEARS.map(y=>'<option>'+y+'</option>').join('')}</select></div>
        <div class="form-group"><label>Type</label>
          <select id="ah_type" class="form-select" style="width:100%"><option>National</option><option>State</option><option>Gazetted</option><option>Restricted</option></select></div></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" id="ah_save"><i class="fas fa-save"></i> Add</button></div>`);
  document.getElementById('ah_save').addEventListener('click',()=>{
    const d=document.getElementById('ah_date').value;
    const n=document.getElementById('ah_name').value.trim();
    if(!d||!n)return toast('Fill date and name','error');
    const hols=DB.get('holidays')||[];
    hols.push({id:'H'+Date.now(),date:d,name:n,year:parseInt(document.getElementById('ah_year').value),type:document.getElementById('ah_type').value});
    DB.set('holidays',hols);closeModal();toast('Holiday added','success');showPage('manageholidays');
  });
}

/* ======== USER MANAGEMENT ======== */
function renderManageUsers(el){
  const users=(DB.get('users')||[]).sort((a,b)=>a.role==='admin'?-1:b.role==='admin'?1:a.name.localeCompare(b.name));
  let html=`<div class="table-container"><div class="table-header"><h3>User Accounts (${users.length})</h3>
    <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="Search..." onkeyup="filterUsers(this.value)"></div></div>
    <div style="overflow-x:auto"><table id="usrTable"><tr><th>#</th><th>Username</th><th>Name</th><th>Role</th><th>Password</th><th>Actions</th></tr>`;
  users.forEach((u,i)=>{
    html+=`<tr data-search="${esc((u.username+' '+u.name).toLowerCase())}">
      <td>${i+1}</td><td><code>${esc(u.username)}</code></td><td>${esc(u.name)}</td>
      <td><span class="desig-badge ${u.role==='admin'?'desig-principal':'desig-lecturer'}">${u.role}</span></td>
      <td style="font-family:monospace;font-size:12px">${esc(u.password)}</td>
      <td class="no-print">
        <button class="btn btn-sm btn-warning" data-action="chpwd" data-uid="${esc(u.username)}"><i class="fas fa-key"></i> Change Password</button>
        ${u.role!=='admin'?`<button class="btn btn-sm btn-danger" data-action="deluser" data-uid="${esc(u.username)}"><i class="fas fa-trash"></i></button>`:''}
      </td></tr>`;
  });
  html+=`</table></div></div>`;
  el.innerHTML=html;
  el.querySelectorAll('[data-action="chpwd"]').forEach(b=>b.addEventListener('click',()=>changePasswordModal(b.dataset.uid)));
  el.querySelectorAll('[data-action="deluser"]').forEach(b=>b.addEventListener('click',()=>{
    if(!confirm('Delete user '+b.dataset.uid+'?'))return;
    let users=DB.get('users')||[];users=users.filter(u=>u.username!==b.dataset.uid);DB.set('users',users);
    toast('User deleted','success');showPage('manageusers');
  }));
}
function filterUsers(q){
  q=q.toLowerCase();document.querySelectorAll('#usrTable tr[data-search]').forEach(r=>{
    r.style.display=r.dataset.search.includes(q)?'':'none';
  });
}
function changePasswordModal(uid){
  openModal(`<div class="modal-header"><h3>Change Password: ${esc(uid)}</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div class="form-group"><label>Security Answer (favourite sport)</label><input type="text" id="cp_ans" placeholder="Answer"></div>
      <div class="form-group"><label>New Password (min 6 chars)</label><input type="text" id="cp_pwd" placeholder="New password"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="cp_save"><i class="fas fa-save"></i> Change</button></div>`);
  document.getElementById('cp_save').addEventListener('click',()=>{
    const ans=document.getElementById('cp_ans').value.trim().toLowerCase();
    const pwd=document.getElementById('cp_pwd').value.trim();
    if(ans!=='cricket')return toast('Wrong security answer','error');
    if(pwd.length<6)return toast('Password must be at least 6 characters','error');
    const users=DB.get('users
  <script>
/* ======== CHANGE PASSWORD (continued) ======== */
    const users=DB.get('users')||[];
    const idx=users.findIndex(u=>u.username===uid);
    if(idx<0)return toast('User not found','error');
    users[idx].password=pwd;
    DB.set('users',users);
    closeModal();toast('Password changed for '+uid,'success');showPage('manageusers');
  });
}

/* ======== REPORTS & PRINT ======== */
function renderReports(el){
  el.innerHTML=`
  <div class="stats-grid" style="margin-bottom:28px">
    <div class="stat-card" style="cursor:pointer" onclick="reportIndividual()">
      <div class="stat-icon"><i class="fas fa-user"></i></div>
      <div class="stat-value" style="font-size:18px">Individual</div>
      <div class="stat-label">Print single faculty report</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="reportDeptWise()">
      <div class="stat-icon"><i class="fas fa-building"></i></div>
      <div class="stat-value" style="font-size:18px">Department</div>
      <div class="stat-label">Department-wise leave report</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="reportMaster()">
      <div class="stat-icon"><i class="fas fa-table"></i></div>
      <div class="stat-value" style="font-size:18px">Master</div>
      <div class="stat-label">Combined all-faculty report</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="reportDeptStaff()">
      <div class="stat-icon"><i class="fas fa-sitemap"></i></div>
      <div class="stat-value" style="font-size:18px">Staff Status</div>
      <div class="stat-label">Department-wise staff count</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="exportCSV()">
      <div class="stat-icon"><i class="fas fa-file-csv"></i></div>
      <div class="stat-value" style="font-size:18px">Export CSV</div>
      <div class="stat-label">Download faculty data as CSV</div>
    </div>
  </div>
  <div id="reportOutput"></div>`;
}

function reportIndividual(){
  const fac=sortFaculty(getActiveFaculty());
  let opts=fac.map(f=>`<option value="${f.id}">${esc(f.name)} (${esc(f.dept)})</option>`).join('');
  openModal(`<div class="modal-header"><h3>Individual Faculty Report</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Select Faculty</label><select id="ri_fac" class="form-select" style="width:100%">${opts}</select></div>
        <div class="form-group"><label>Year</label><select id="ri_year" class="form-select" style="width:100%">${YEARS.map(y=>'<option>'+y+'</option>').join('')}</select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="ri_gen"><i class="fas fa-file-alt"></i> Generate</button></div>`);
  document.getElementById('ri_gen').addEventListener('click',()=>{
    const fid=document.getElementById('ri_fac').value;
    const year=parseInt(document.getElementById('ri_year').value);
    closeModal();
    genIndividualReport(fid,year);
  });
}

function genIndividualReport(fid,year){
  const fac=(DB.get('faculty')||[]).find(f=>f.id===fid);if(!fac)return;
  const leaves=DB.get('leaves')||{};
  const data=(leaves[year]&&leaves[year][fid])||{};
  let total=0;Object.values(data).forEach(v=>total+=v);
  let html=`
  <div class="table-container" style="margin-top:0">
    <div class="table-header"><h3>Leave Report: ${esc(fac.name)} (${year})</h3>
      <button class="btn btn-sm btn-outline no-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button></div>
    <div style="padding:24px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;font-size:13px">
        <div class="profile-field"><span class="label">Name</span><span class="value">${esc(fac.name)}</span></div>
        <div class="profile-field"><span class="label">Teacher Code</span><span class="value">${esc(fac.code)}</span></div>
        <div class="profile-field"><span class="label">Designation</span><span class="value">${fac.isPrincipal?'Principal & ':''}${esc(fac.designation)}</span></div>
        <div class="profile-field"><span class="label">Department</span><span class="value">${esc(fac.dept)}</span></div>
        <div class="profile-field"><span class="label">DOJ</span><span class="value">${fmtDate(fac.doj)}</span></div>
        <div class="profile-field"><span class="label">Experience</span><span class="value">${calcExp(fac.doj)}</span></div>
      </div>
      <table><tr><th>Leave Type</th><th>Days Taken</th></tr>`;
  LEAVE_TYPES.forEach(lt=>{const v=data[lt]||0;
    html+=`<tr><td>${lt}</td><td style="font-weight:${v>0?'700':'400'};color:${v>0?'var(--danger)':'var(--text)'}">${v}</td></tr>`});
  html+=`<tr style="background:var(--bg);font-weight:700"><td>Total Leave Days</td><td style="color:var(--danger)">${total}</td></tr>`;
  html+=`</table></div></div>`;
  document.getElementById('reportOutput').innerHTML=html;
}

function reportDeptWise(){
  let opts=DEPTS.map(d=>`<option>${d}</option>`).join('');
  openModal(`<div class="modal-header"><h3>Department-wise Report</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label>Department</label><select id="rd_dept" class="form-select" style="width:100%">${opts}</select></div>
        <div class="form-group"><label>Year</label><select id="rd_year" class="form-select" style="width:100%">${YEARS.map(y=>'<option>'+y+'</option>').join('')}</select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="rd_gen"><i class="fas fa-file-alt"></i> Generate</button></div>`);
  document.getElementById('rd_gen').addEventListener('click',()=>{
    const dept=document.getElementById('rd_dept').value;
    const year=parseInt(document.getElementById('rd_year').value);
    closeModal();
    genDeptReport(dept,year);
  });
}

function genDeptReport(dept,year){
  const fac=sortFaculty(getActiveFaculty().filter(f=>f.dept===dept));
  const leaves=DB.get('leaves')||{};
  let html=`<div class="table-container" style="margin-top:0">
    <div class="table-header"><h3>Department: ${esc(dept)} — Leave Report (${year})</h3>
      <button class="btn btn-sm btn-outline no-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button></div>
    <div style="overflow-x:auto"><table><tr><th>#</th><th>Name</th><th>Designation</th>`;
  LEAVE_TYPES.forEach(lt=>html+=`<th style="font-size:10px">${lt}</th>`);
  html+=`<th>Total</th></tr>`;
  fac.forEach((f,i)=>{
    const d=(leaves[year]&&leaves[year][f.id])||{};
    let total=0;LEAVE_TYPES.forEach(lt=>total+=(d[lt]||0));
    html+=`<tr><td>${i+1}</td><td style="font-weight:600;font-size:12px">${esc(f.name)}</td>
      <td><span class="desig-badge desig-${f.designation.toLowerCase()}">${f.isPrincipal?'Principal':esc(f.designation)}</span></td>`;
    LEAVE_TYPES.forEach(lt=>{const v=d[lt]||0;html+=`<td style="text-align:center;font-weight:${v>0?'700':'400'};color:${v>0?'var(--danger)':'var(--text)'}">${v}</td>`});
    html+=`<td style="font-weight:700">${total}</td></tr>`;
  });
  html+=`</table></div></div>`;
  if(!fac.length)html=`<div class="empty-state"><i class="fas fa-users-slash"></i><p>No faculty in this department</p></div>`;
  document.getElementById('reportOutput').innerHTML=html;
}

function reportMaster(){
  let yearSel=`<select id="rm_year" class="form-select">${YEARS.map(y=>'<option>'+y+'</option>').join('')}</select>`;
  openModal(`<div class="modal-header"><h3>Master Report</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
    <div class="modal-body"><div class="form-group"><label>Year</label>${yearSel}</div></div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="rm_gen"><i class="fas fa-file-alt"></i> Generate</button></div>`);
  document.getElementById('rm_gen').addEventListener('click',()=>{
    const year=parseInt(document.getElementById('rm_year').value);
    closeModal();genMasterReport(year);
  });
}

function genMasterReport(year){
  const fac=sortFaculty(getActiveFaculty());
  const leaves=DB.get('leaves')||{};
  let html=`<div class="table-container" style="margin-top:0">
    <div class="table-header"><h3>Master Leave Report — All Faculty (${year})</h3>
      <button class="btn btn-sm btn-outline no-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button></div>
    <div style="overflow-x:auto"><table><tr><th>#</th><th>Name</th><th>Dept</th><th>Desig.</th>`;
  LEAVE_TYPES.forEach(lt=>html+=`<th style="font-size:9px">${lt}</th>`);
  html+=`<th>Total</th></tr>`;
  let grandTotal=0;
  fac.forEach((f,i)=>{
    const d=(leaves[year]&&leaves[year][f.id])||{};
    let total=0;LEAVE_TYPES.forEach(lt=>total+=(d[lt]||0));
    grandTotal+=total;
    html+=`<tr><td>${i+1}</td><td style="font-weight:600;font-size:11px;white-space:nowrap">${esc(f.name)}</td>
      <td style="font-size:10px">${esc(f.dept)}</td>
      <td><span class="desig-badge desig-${f.designation.toLowerCase()}" style="font-size:10px">${f.isPrincipal?'P':f.designation.charAt(0)}</span></td>`;
    LEAVE_TYPES.forEach(lt=>{const v=d[lt]||0;html+=`<td style="text-align:center;font-size:11px;font-weight:${v>0?'700':'400'};color:${v>0?'var(--danger)':'inherit'}">${v||'-'}</td>`});
    html+=`<td style="font-weight:700;text-align:center">${total||'-'}</td></tr>`;
  });
  html+=`<tr style="background:var(--bg);font-weight:700"><td colspan="4">Grand Total</td>`;
  LEAVE_TYPES.forEach(lt=>{
    let sum=0;fac.forEach(f=>{const d=(leaves[year]&&leaves[year][f.id])||{};sum+=(d[lt]||0)});
    html+=`<td style="text-align:center">${sum||'-'}</td>`;
  });
  html+=`<td style="text-align:center;color:var(--danger)">${grandTotal}</td></tr>`;
  html+=`</table></div></div>`;
  document.getElementById('reportOutput').innerHTML=html;
}

function reportDeptStaff(){
  const fac=getActiveFaculty();
  let html=`<div class="table-container" style="margin-top:0">
    <div class="table-header"><h3>Department-wise Staff Status (MUHS LIC — 100 UG Seats)</h3>
      <button class="btn btn-sm btn-outline no-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button></div>
    <div style="overflow-x:auto"><table>
      <tr><th>#</th><th>Department</th><th>Professor</th><th>Reader/Assoc.</th><th>Lecturer/Asst.</th><th>Total</th><th>Principal</th></tr>`;
  let tProf=0,tRead=0,tLect=0,tAll=0,tPrin=0;
  DEPTS.forEach((d,i)=>{
    const df=fac.filter(f=>f.dept===d);
    const prof=df.filter(f=>f.designation==='Professor').length;
    const read=df.filter(f=>f.designation==='Reader').length;
    const lect=df.filter(f=>f.designation==='Lecturer').length;
    const prin=df.filter(f=>f.isPrincipal).length;
    tProf+=prof;tRead+=read;tLect+=lect;tAll+=df.length;tPrin+=prin;
    html+=`<tr><td>${i+1}</td><td style="font-weight:600"><span class="dept-badge" style="background:${deptColor(d)}22;color:${deptColor(d)}">${esc(d)}</span></td>
      <td style="text-align:center">${prof}</td><td style="text-align:center">${read}</td>
      <td style="text-align:center">${lect}</td><td style="text-align:center;font-weight:700">${df.length}</td>
      <td style="text-align:center">${prin?'<span class="desig-badge desig-principal">Yes</span>':'-'}</td></tr>`;
  });
  html+=`<tr style="background:var(--bg);font-weight:700"><td colspan="2">Total</td>
    <td style="text-align:center">${tProf}</td><td style="text-align:center">${tRead}</td>
    <td style="text-align:center">${tLect}</td><td style="text-align:center">${tAll}</td>
    <td style="text-align:center">${tPrin}</td></tr>`;
  html+=`</table></div></div>`;
  document.getElementById('reportOutput').innerHTML=html;
}

function exportCSV(){
  const fac=sortFaculty(getActiveFaculty());
  const leaves=DB.get('leaves')||{};
  let csv='Sr,Name,Code,Designation,Department,DOJ,DOB,Email,Phone,Approved,Principal';
  YEARS.forEach(y=>{LEAVE_TYPES.forEach(lt=>csv+=','+y+'_'+lt);csv+=','+y+'_Total'});
  csv+='\n';
  fac.forEach((f,i)=>{
    csv+=`${i+1},"${f.name}","${f.code}","${f.designation}","${f.dept}","${f.doj||''}","${f.dob||''}","${f.email||''}","${f.phone||''}","${f.approved}","${f.isPrincipal?'Yes':'No'}"`;
    YEARS.forEach(y=>{
      const d=(leaves[y]&&leaves[y][f.id])||{};
      let total=0;
      LEAVE_TYPES.forEach(lt=>{const v=d[lt]||0;csv+=','+v;total+=v});
      csv+=','+total;
    });
    csv+='\n';
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='DAMCH_Faculty_Data_'+new Date().toISOString().split('T')[0]+'.csv';
  a.click();toast('CSV exported','success');
}

/* ======== BACKUP & RESTORE ======== */
function renderBackup(el){
  el.innerHTML=`
  <div class="stats-grid">
    <div class="stat-card" style="cursor:pointer" onclick="downloadBackup()">
      <div class="stat-icon"><i class="fas fa-download"></i></div>
      <div class="stat-value" style="font-size:18px">Download</div>
      <div class="stat-label">Full JSON backup of all data</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="document.getElementById('restoreInput').click()">
      <div class="stat-icon"><i class="fas fa-upload"></i></div>
      <div class="stat-value" style="font-size:18px">Restore</div>
      <div class="stat-label">Upload JSON backup file</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="resetAll()">
      <div class="stat-icon"><i class="fas fa-redo"></i></div>
      <div class="stat-value" style="font-size:18px">Reset</div>
      <div class="stat-label">Reset to default data</div>
    </div>
  </div>
  <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreBackup(this)">
  <div class="table-container" style="margin-top:20px">
    <div class="table-header"><h3><i class="fas fa-info-circle" style="color:var(--info);margin-right:8px"></i>Backup Information</h3></div>
    <div style="padding:24px;line-height:2;font-size:14px">
      <p><strong>Data Storage:</strong> All data is stored in your browser's localStorage. Clearing browser data will erase everything.</p>
      <p><strong>Weekly Backup:</strong> Download a JSON backup weekly and save it to Google Drive, USB, or another safe location.</p>
      <p><strong>Restore:</strong> Upload a previously downloaded JSON file to restore all faculty, leaves, holidays, and user data.</p>
      <p><strong>Reset:</strong> Resets the entire database to the original 50 faculty members with default passwords.</p>
      <p style="margin-top:12px"><strong>Last backup keys in storage:</strong></p>
      <p style="font-family:monospace;font-size:12px;color:var(--text-light)">
        users (${(DB.get('users')||[]).length} records) | 
        faculty (${(DB.get('faculty')||[]).length} records) | 
        leaves (${YEARS.length} years) | 
        holidays (${(DB.get('holidays')||[]).length} records) |
        applications (${(DB.get('leaveApplications')||[]).length} records)
      </p>
    </div>
  </div>`;
}

function downloadBackup(){
  const backup={
    version:'DAMCH_v7',
    date:new Date().toISOString(),
    users:DB.get('users'),
    faculty:DB.get('faculty'),
    leaves:DB.get('leaves'),
    leaveApplications:DB.get('leaveApplications'),
    holidays:DB.get('holidays')
  };
  const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='DAMCH_Backup_'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  toast('Backup downloaded successfully','success');
}

function restoreBackup(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      if(!data.version||!data.users||!data.faculty)throw new Error('Invalid backup file');
      if(!confirm('This will REPLACE all current data with the backup. Continue?'))return;
      DB.set('users',data.users);
      DB.set('faculty',data.faculty);
      DB.set('leaves',data.leaves||{});
      DB.set('leaveApplications',data.leaveApplications||[]);
      DB.set('holidays',data.holidays||[]);
      toast('Data restored successfully! Refreshing...','success');
      setTimeout(()=>location.reload(),1500);
    }catch(err){
      toast('Invalid backup file: '+err.message,'error');
    }
  };
  reader.readAsText(file);
  input.value='';
}

function resetAll(){
  if(!confirm('⚠️ RESET ALL DATA?\n\nThis will delete all current data and restore the original 50 faculty members with default passwords.\n\nDownload a backup first if needed!'))return;
  if(!confirm('Are you absolutely sure? This cannot be undone.'))return;
  // Clear all
  ['users','faculty','leaves','leaveApplications','holidays','db_initialized_v7'].forEach(k=>DB.del(k));
  toast('Database reset! Refreshing...','success');
  setTimeout(()=>location.reload(),1500);
}

/* ======== INITIALIZATION ======== */
initDB();

// Check if on mobile
if(window.innerWidth<=768){
  document.getElementById('menuBtn').style.display='flex';
}
window.addEventListener('resize',()=>{
  document.getElementById('menuBtn').style.display=window.innerWidth<=768?'flex':'none';
  if(window.innerWidth>768)document.getElementById('sidebar').classList.remove('open');
});

// Enter key on login
document.getElementById('loginPass').addEventListener('keypress',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('loginUser').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});
</script>
</body>
</html>
