<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Book & Leave Record - DAMCH Udgir</title>
    <style>
        /* ===== GLOBAL ===== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #e8eaf6; color: #000; font-size: 11px; }

        /* ===== LOGIN PAGE ===== */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a237e 0%, #b71c1c 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: #fff; border-radius: 12px; padding: 30px 35px; width: 380px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4); text-align: center;
        }
        .login-box .login-logo { width: 70px; height: 70px; margin: 0 auto 8px; }
        .login-box .login-logo img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #b71c1c; }
        .login-box h2 { color: #b71c1c; font-size: 15px; margin-bottom: 2px; text-transform: uppercase; }
        .login-box h4 { color: #333; font-size: 11px; margin-bottom: 15px; font-weight: 600; }
        .login-box input {
            width: 100%; padding: 10px 12px; margin-bottom: 10px; border: 1.5px solid #bbb;
            border-radius: 6px; font-size: 13px; outline: none; transition: border 0.3s;
        }
        .login-box input:focus { border-color: #b71c1c; background: #fff8e1; }
        .login-box .login-btn {
            width: 100%; padding: 11px; background: #b71c1c; color: #fff; border: none;
            border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;
            transition: background 0.3s;
        }
        .login-box .login-btn:hover { background: #d32f2f; }
        .login-msg { color: #b71c1c; font-size: 11px; font-weight: bold; margin-top: 8px; min-height: 16px; }
        .login-footer { font-size: 9px; color: #888; margin-top: 12px; }
        .login-footer a { color: #1a237e; }
        .toggle-pw { font-size: 10px; color: #1a237e; cursor: pointer; text-align: right; display: block; margin: -6px 0 8px; }

        /* ===== PROFILE MODAL ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center;
            align-items: center; z-index: 8000;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: #fff; border-radius: 10px; padding: 20px 25px; width: 460px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-box h3 { color: #b71c1c; border-bottom: 2px solid #b71c1c; padding-bottom: 6px; margin-bottom: 12px; font-size: 15px; }
        .modal-box label { font-weight: bold; font-size: 11px; color: #333; display: block; margin-top: 8px; }
        .modal-box input, .modal-box select {
            width: 100%; padding: 7px 10px; border: 1.5px solid #ccc; border-radius: 5px;
            font-size: 12px; margin-top: 3px;
        }
        .modal-box input:focus, .modal-box select:focus { border-color: #1a237e; background: #e8eaf6; }
        .modal-box .readonly-field { background: #f5f5f5; color: #555; cursor: not-allowed; }
        .modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .modal-btns { margin-top: 15px; text-align: right; }
        .modal-btns button { padding: 8px 18px; border: none; border-radius: 5px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 8px; }
        .mbtn-save { background: #2e7d32; color: #fff; }
        .mbtn-cancel { background: #757575; color: #fff; }
        .mbtn-save:hover { background: #388e3c; }
        .mbtn-cancel:hover { background: #888; }
        .date-input-group { display: flex; gap: 4px; align-items: center; }
        .date-input-group input { width: 50px; text-align: center; padding: 7px 4px; }
        .date-input-group input.yr-input { width: 65px; }
        .date-input-group span { font-weight: bold; color: #999; font-size: 14px; }

        /* ===== HEADER ===== */
        .header-section {
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid #b71c1c; padding: 8px; background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .logo-area { width: 60px; height: 60px; border: 2px dashed #555; display: flex; justify-content: center; align-items: center; cursor: pointer; background: #f9f9f9; border-radius: 6px; }
        .logo-area img { max-width: 100%; max-height: 100%; border-radius: 4px; }
        .title-area { text-align: center; flex-grow: 1; }
        .college-name { font-size: 17px; font-weight: 900; color: #b71c1c; text-transform: uppercase; margin: 2px 0 0; }
        .college-addr { font-size: 11px; font-weight: bold; color: #444; margin-bottom: 3px; }
        .user-info-bar { text-align: right; font-size: 10px; font-weight: bold; }
        .user-info-bar .user-name { color: #1a237e; font-size: 12px; }
        .logout-btn { background: #b71c1c; color: #fff; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; margin-top: 4px; }
        .profile-btn { background: #1a237e; color: #fff; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; margin-top: 4px; }

        /* ===== CONTROLS ===== */
        .mgmt-panel {
            background: #fff; padding: 8px; margin: 8px 5px; border-left: 6px solid #2e7d32;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-btn { padding: 6px 20px; border: 2px solid #b71c1c; background: #fff; color: #b71c1c; cursor: pointer; font-weight: bold; font-size: 12px; }
        .tab-btn.active { background: #b71c1c; color: #fff; }

        /* ===== TABLE ===== */
        .table-container { overflow-x: auto; background: #fff; border: 2px solid #444; max-height: 78vh; margin: 0 5px; }
        table.main-table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 1900px; }
        th, td { border: 1px solid #555; padding: 3px; text-align: center; vertical-align: middle; color: #000; }
        thead th { position: sticky; top: 0; z-index: 10; height: 32px; font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.3px; }
        .head-paid { background-color: #1b5e20; color: #fff; border-color: #fff; }
        .head-unpaid { background-color: #b71c1c; color: #fff; border-color: #fff; }
        .th-paid { background-color: #2e7d32; color: #fff; }
        .th-unpaid { background-color: #d32f2f; color: #fff; }
        .th-late { background-color: #000; color: #fff; }
        .th-tot { background-color: #212121; color: #fff; }
        .col-fix { position: sticky; left: 0; background: #eee; z-index: 5; width: 35px; border-right: 2px solid #000; font-weight: bold; }
        .col-fix-2 { position: sticky; left: 35px; background: #eee; z-index: 5; width: 240px; text-align: left; border-right: 2px solid #000; padding-left: 5px; }
        input[type="number"] { width: 35px; text-align: center; border: 1px solid #333; background: #fff; color: #000; font-weight: bold; font-size: 12px; padding: 2px; }
        input[type="text"], input[type="date"] { width: 96%; font-size: 11px; border: 1px solid #555; margin-bottom: 2px; font-weight: 600; color: #000; background: #fff; padding: 1px; }
        input:focus { background: #fff9c4; outline: 2px solid #000; }
        .info-label { font-size: 9px; color: #333; font-weight: bold; display: block; }
        .exp-tag { font-size: 10px; color: #0d47a1; font-weight: bold; background: #e3f2fd; padding: 2px; border-radius: 3px; border: 1px solid #bbdefb; display: block; margin-top: 2px; text-align: center; }
        .bg-bal { background: #e0e0e0; font-weight: 900; color: #000; font-size: 11px; }
        .bg-bal-neg { background: #ffcdd2; color: #b71c1c; font-weight: 900; border: 1px solid #b71c1c; }
        .tot-paid-cell { background: #a5d6a7; border: 2px solid #1b5e20 !important; font-weight: 900; color: #000; font-size: 12px; }
        .tot-unpaid-cell { background: #ef9a9a; border: 2px solid #b71c1c !important; font-weight: 900; color: #000; font-size: 12px; }
        .grand-tot-cell { background: #fff176; border: 2px solid #f57f17 !important; font-weight: 900; font-size: 14px; color: #000; }

        /* ===== BUTTONS ===== */
        .btn { border: 1px solid #333; padding: 5px 10px; color: #fff; cursor: pointer; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .btn-del { background: #d32f2f; }
        .btn-save { background: #0277bd; }
        .btn-print-ind { background: #455a64; }
        .btn-print-mst { background: #e65100; }
        .btn-search { background: #6a1b9a; }
        .btn-calc { background: #d84315; border: 2px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* ===== FOOTER ===== */
        .dev-footer { text-align: center; padding: 8px; font-size: 10px; color: #555; margin-top: 10px; border-top: 1px solid #ccc; background: #f5f5f5; }
        .dev-footer b { color: #1a237e; }

        /* ===== PRINT ===== */
        #printSection { display: none; }
        @media print {
            body { background: white; color: black; -webkit-print-color-adjust: exact; }
            .screen-only { display: none !important; }
            #printSection { display: block !important; width: 100%; }
            @page { size: A4 portrait; margin: 0.5cm; }
            .rpt-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 8px; table-layout: fixed; border: 2px solid #000 !important; }
            .rpt-table th, .rpt-table td { border: 1px solid #000 !important; padding: 2px 1px; text-align: center; color: black; word-wrap: break-word; }
            .rpt-table th { background-color: #ddd !important; font-weight: bold; }
            .rpt-header { display: flex; align-items: center; border-bottom: 2px solid black !important; padding-bottom: 5px; margin-bottom: 10px; }
            .rpt-logo { width: 60px; height: 60px; margin-right: 10px; }
            .rpt-logo img { max-width: 100%; max-height: 100%; }
            .rpt-titles { text-align: center; flex-grow: 1; }
            .rpt-titles h3 { margin: 2px 0; font-size: 14px; }
            .rpt-titles h2 { margin: 2px 0; font-size: 16px; font-weight: 900; }
            .rpt-titles h5 { margin: 2px 0; font-size: 10px; }
            .dept-head { background-color: #eee; font-weight: bold; text-align: left; padding: 3px; font-size: 10px; border: 1px solid #000 !important; margin-top: 5px; }
            .ind-card { border: 1px solid #000 !important; padding: 5px; margin-bottom: 10px; page-break-inside: avoid; width: 99%; }
            .ind-header { border-bottom: 1px solid #000 !important; padding-bottom: 2px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
            .ind-title { font-size: 12px; font-weight: bold; }
            .ind-meta { font-size: 9px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 2px; }
            .ind-table { width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 2px; }
            .ind-table th, .ind-table td { border: 1px solid #000 !important; padding: 2px; text-align: center; color: black; }
            .ind-table th { background: #eee !important; font-weight: bold; }
            .ind-sect-title { font-size: 9px; font-weight: bold; background: #333; color: white; padding: 1px 3px; margin-top: 3px; -webkit-print-color-adjust: exact; }
            .ind-summary { margin-top: 2px; border-top: 1px solid #000 !important; padding-top: 2px; display: flex; justify-content: flex-end; gap: 10px; font-weight: bold; font-size: 10px; }
            .print-footer { text-align: center; font-size: 8px; color: #555; margin-top: 10px; border-top: 1px solid #999; padding-top: 4px; }
        }
    </style>
</head>
<body>

<!-- ===== LOGIN PAGE ===== -->
<div class="login-overlay" id="loginPage">
    <div class="login-box">
        <div class="login-logo" id="loginLogoArea"><img id="loginLogoImg" src="" style="display:none"><span id="loginLogoTxt" style="font-size:28px; color:#b71c1c; font-weight:900;">DAMCH</span></div>
        <h2>Dhanwantari Ayurved Medical College</h2>
        <h4>Tq. Udgir, Dist. Latur, Maharashtra</h4>
        <p style="font-size:12px; font-weight:bold; color:#1a237e; margin-bottom:12px;">Faculty Service Book & Leave Record</p>
        <input type="text" id="loginUser" placeholder="Username (Teacher Code or admin)" autocomplete="off">
        <input type="password" id="loginPass" placeholder="Password">
        <span class="toggle-pw" onclick="togglePw()">Show Password</span>
        <button class="login-btn" onclick="doLogin()">LOGIN</button>
        <div class="login-msg" id="loginMsg"></div>
        <div class="login-footer">
            Phone: (02385) 259825 | Email: contact@damchudgir.edu.in<br>
            <a href="http://www.damchudgir.edu.in" target="_blank">www.damchudgir.edu.in</a><br><br>
            <b style="color:#1a237e;">Designed & Developed by Dr. Jadhav V.R.</b>
        </div>
    </div>
</div>
<!-- ===== MAIN APP (hidden until login) ===== -->
<div class="screen-only" id="mainApp" style="display:none; padding:5px;">

    <div class="header-section">
        <div class="logo-area" onclick="document.getElementById('logoInput').click()">
            <img id="logoImg" style="display:none">
            <span id="logoTxt" style="font-weight:bold; color:#000; font-size:9px;">UPLOAD<br>LOGO</span>
        </div>
        <input type="file" id="logoInput" style="display:none" accept="image/*" onchange="loadLogo(event)">

        <div class="title-area">
            <div contenteditable="true" id="tHead" style="font-size:12px; font-weight:bold; color:#333;">Bal Bhagwan Shikshan Prasarak Mandal Ahmedpur's</div>
            <div contenteditable="true" class="college-name" id="cHead">Dhanwantari Ayurved Medical College & Charitable Hospital</div>
            <div contenteditable="true" class="college-addr" id="cAddr">Tq. Udgir Dist. Latur Maharashtra State</div>
            <div style="font-size:13px; font-weight:bold; color:#333;">Faculty Service Book & Leave Record</div>
        </div>

        <div class="user-info-bar">
            Date: <input type="text" id="reportDate" onchange="render()" style="border:none; border-bottom:1px dashed #333; background:transparent; font-weight:bold; font-size:11px; width:90px; text-align:center;" placeholder="DD/MM/YYYY"><br>
            <span class="user-name" id="dispUserName"></span><br>
            <span id="dispUserRole" style="color:#555; font-size:9px;"></span><br>
            <button class="profile-btn" onclick="openProfile()">My Profile</button>
            <button class="logout-btn" onclick="doLogout()">Logout</button>
        </div>
    </div>

    <div style="text-align:center; margin:5px 0;">
        <button class="tab-btn active" id="btn25" onclick="swYear('2025')">2025</button>
        <button class="tab-btn" id="btn26" onclick="swYear('2026')">2026</button>
    </div>

    <div class="mgmt-panel" id="adminPanel">
        <div>
            <b style="color:#2e7d32;">Manage Faculty</b>
            <button class="btn" style="background:#2e7d32;" onclick="addRow()">+ Add Faculty</button>
            <button class="btn btn-search" onclick="searchFaculty()">Search</button>
        </div>
        <div>
            <button class="btn btn-calc" onclick="calculateCarryForward()" title="Calc EL from 2025 to 2026">Auto EL Carry Forward (2025â†’2026)</button>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
            <div>
                <span class="info-label" style="display:inline;">Detailed:</span>
                <button class="btn btn-print-ind" onclick="genIndividualReport(null)">All Faculty</button>
                <button class="btn btn-print-ind" style="background:#00838f;" onclick="askDetailedDeptReport()">Dept Wise</button>
            </div>
            <div>
                <span class="info-label" style="display:inline;">Summary:</span>
                <button class="btn btn-print-mst" onclick="genMasterReport(null)">Master All</button>
                <button class="btn btn-print-mst" style="background:#f57f17; color:#000;" onclick="askDeptReport()">Dept Wise</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <h3 id="yrTitle" style="text-align:center; margin:5px; color:#000; font-weight:900;">Record: 2025</h3>
        <table class="main-table" id="mainTable">
            <thead>
                <tr>
                    <th rowspan="3" class="col-fix">Sr</th>
                    <th rowspan="3" class="col-fix-2">Faculty Details & Experience</th>
                    <th colspan="23" class="head-paid">PAID LEAVE SECTION</th>
                    <th colspan="2" class="head-unpaid">UNPAID</th>
                    <th rowspan="3" class="th-tot">GRAND<br>TOTAL</th>
                    <th rowspan="3" id="actionColHead" style="width:50px; background:#333; color:white;">ACT</th>
                </tr>
                <tr>
                    <th colspan="2" class="th-paid">CL(8)</th>
                    <th colspan="2" class="th-paid">ML(10)</th>
                    <th colspan="1" class="th-paid">OD</th>
                    <th colspan="5" class="th-paid" style="background:#1565c0;">EL (Earned)</th>
                    <th colspan="2" class="th-late">Late(1/6)</th>
                    <th colspan="2" class="th-paid">Mat(180)</th>
                    <th colspan="2" class="th-paid" style="background:#004d40;">Pat(15)</th>
                    <th colspan="2" class="th-paid">SL(15)</th>
                    <th colspan="2" class="th-paid">Sp.Dis(120)</th>
                    <th colspan="2" class="th-paid">RH(2)</th>
                    <th rowspan="2" class="th-tot">PAID<br>USED</th>
                    <th colspan="1" class="th-unpaid" style="background:#8e0000;">LWP</th>
                    <th rowspan="2" class="th-unpaid">TOT<br>UNPD</th>
                </tr>
                <tr style="font-size:10px; background:#424242; color:white;">
                    <th>Used</th><th>Bal</th>
                    <th>Used</th><th>Bal</th>
                    <th>Used</th>
                    <th>Open</th><th>New</th><th>Tot</th><th>Used</th><th style="background:#1565c0;">Bal</th>
                    <th>Cnt</th><th>Ded</th>
                    <th>Used</th><th>Bal</th>
                    <th>Used</th><th>Bal</th>
                    <th>Used</th><th>Bal</th>
                    <th>Used</th><th>Bal</th>
                    <th>Used</th><th>Bal</th>
                    <th>Used</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <div style="margin-top:8px; text-align:right; padding:0 5px;">
        <span id="adminBtns">
            <button class="btn btn-save" onclick="saveData()">Save to Browser</button>
            <button class="btn btn-save" style="background:#5e35b1;" onclick="downloadJSON()">Download JSON</button>
            <button class="btn btn-save" style="background:#00695c;" onclick="expCSV()">Export Excel</button>
            <span style="border-left:2px solid #555; margin:0 5px; height:20px; display:inline-block; vertical-align:middle;"></span>
            <input type="file" id="restFile" style="display:none" accept=".json" onchange="restData(event)">
            <button class="btn btn-save" style="background:#6a1b9a;" onclick="document.getElementById('restFile').click()">Restore Data</button>
        </span>
    </div>

    <div class="dev-footer">Designed & Developed by <b>Dr. Jadhav V.R.</b> | Contact: 9518356305</div>
</div>

<!-- ===== PROFILE MODAL ===== -->
<div class="modal-overlay" id="profileModal">
    <div class="modal-box">
        <h3>My Profile</h3>
        <label>Name</label>
        <input type="text" id="pf_name" class="readonly-field" readonly>
        <label>Designation</label>
        <input type="text" id="pf_desig" class="readonly-field" readonly>
        <label>Department</label>
        <input type="text" id="pf_dept" class="readonly-field" readonly>
        <label>Teacher Code</label>
        <input type="text" id="pf_code" class="readonly-field" readonly>

        <div class="modal-row">
            <div>
                <label>Date of Joining (DD/MM/YYYY)</label>
                <div class="date-input-group">
                    <input type="text" id="pf_doj_dd" maxlength="2" placeholder="DD" oninput="autoTab(this,'pf_doj_mm')">
                    <span>/</span>
                    <input type="text" id="pf_doj_mm" maxlength="2" placeholder="MM" oninput="autoTab(this,'pf_doj_yyyy')">
                    <span>/</span>
                    <input type="text" id="pf_doj_yyyy" class="yr-input" maxlength="4" placeholder="YYYY">
                </div>
            </div>
            <div>
                <label>Date of Birth (DD/MM/YYYY)</label>
                <div class="date-input-group">
                    <input type="text" id="pf_dob_dd" maxlength="2" placeholder="DD" oninput="autoTab(this,'pf_dob_mm')">
                    <span>/</span>
                    <input type="text" id="pf_dob_mm" maxlength="2" placeholder="MM" oninput="autoTab(this,'pf_dob_yyyy')">
                    <span>/</span>
                    <input type="text" id="pf_dob_yyyy" class="yr-input" maxlength="4" placeholder="YYYY">
                </div>
            </div>
        </div>

        <label>Change Password</label>
        <input type="password" id="pf_newpw" placeholder="Leave blank to keep current">

        <div class="modal-btns">
            <button class="mbtn-cancel" onclick="closeProfile()">Cancel</button>
            <button class="mbtn-save" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>
</div>

<div id="printSection"></div>
<script>
/* ===== GLOBALS ===== */
var curYr = '2025';
var data = [];
var users = {};
var currentUser = null; // {username, role, facultyId}

var desigRank = {"PRINCIPAL":1,"PROFESSOR":2,"ASSOCIATE PROFESSOR":3,"READER":3,"ASSISTANT PROFESSOR":4,"LECTURER":4};

/* ===== DEFAULT DATA (Your 42 Faculty from JSON) ===== */
var DEFAULT_DATA = [
{"id":1767934321233,"name":"Dr.Patil Dattatraya Vinayakrao","desig":"Principal","dept":"Sanskrit Samhita Siddhant","code":"AYSS00481","doj":"2003-12-23","dob":"1977-05-05","leaves_2025":{"cl":"7","od":"15","lat":"48","ml":"0","el_open":"0"},"leaves_2026":{"el_open":15}},
{"id":1767955726188,"name":"Dr.Shrigire Sayaram Ramgonda","desig":"Professor","dept":"Dravayaguna Vidnyan","code":"AYDG00564","doj":"2003-01-18","dob":"1969-01-01","leaves_2025":{"cl":"8","ml":"2","od":"7","lat":"84"},"leaves_2026":{"el_open":11}},
{"id":1767958577405,"name":"Dr.Kattewar Balaji Devrao","desig":"Professor","dept":"RSBK","code":"AYBK","doj":"2003-07-01","dob":"1973-09-11","leaves_2025":{"cl":"8","od":"1","el_u":"2","lat":"12"},"leaves_2026":{"el_open":13}},
{"id":1767955330141,"name":"Dr. Mundhe Mangesh Gopinath","desig":"Professor","dept":"PTSR","code":"AYPS00366","doj":"2005-03-04","dob":"1975-07-23","leaves_2025":{"cl":"8","od":"10","lat":"180"},"leaves_2026":{"el_open":0}},
{"id":1768206052606,"name":"Pushpa Dagdu Gawale","desig":"Professor","dept":"Kayachikitsa","code":"AYKC0","doj":"2008-10-20","dob":"","leaves_2025":{"cl":"8","ml":"10","lwp":"4","od":"0","sl":"5","el_u":"15","lat":"138","sd":"0","rh":"0","pat":"0","mat":"0"},"leaves_2026":{}},
{"id":1767961042431,"name":"Dr.Amol Umakant Patane","desig":"Professor","dept":"Panchakarma","code":"AYPK00687","doj":"2012-12-22","dob":"1982-12-17","leaves_2025":{"cl":"8","ml":"1","od":"5","el_u":"3","lat":"164"},"leaves_2026":{"el_open":0}},
{"id":1768021186994,"name":"Dr.Bansode Namdev Manohar","desig":"Professor","dept":"Rognidan evum VV","code":"AYRN0325","doj":"2014-09-01","dob":"","leaves_2025":{"cl":"8","ml":"1","od":"4","el_u":"6","lat":"138"},"leaves_2026":{"el_open":15}},
{"id":1768278195240,"name":"Dr.Ravikant Vinayakrao Patil","desig":"Professor","dept":"Shalakyatantra","code":"AYSK0659","doj":"2018-12-27","dob":"","leaves_2025":{"cl":"7","ml":"0","od":"6","el_u":"6","lat":"176","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0"},"leaves_2026":{}},
{"id":1768021174955,"name":"Dr.Mundhe Vishnukant Dnyanoba","desig":"Professor","dept":"","code":"","doj":"","dob":"","leaves_2025":{},"leaves_2026":{"el_open":15}},
{"id":1767959422862,"name":"Dr.Sachinkumar Vishwanath Tale","desig":"Associate Professor","dept":"Swasthavritta","code":"AYSV00250","doj":"2018-01-01","dob":"1990-06-24","leaves_2025":{"cl":"8","ml":"5","od":"4","el_u":"7","lat":"116"},"leaves_2026":{"el_open":0}},
{"id":1768201062768,"name":"Rashmi Yogiraj Chidre","desig":"Associate Professor","dept":"","code":"AYPS00416","doj":"2018-01-09","dob":"","leaves_2025":{"cl":"8","ml":"10","od":"1","el_u":"15","lat":"157","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0","lwp":"21"},"leaves_2026":{}},
{"id":1768021173715,"name":"Dr.Mayuri Udaysingh Thakur","desig":"Associate Professor","dept":"Rachana Sharir","code":"AYRS00376","doj":"2018-07-02","dob":"","leaves_2025":{"cl":"8","ml":"10","od":"1","lat":"91","el_u":"0","mat":"56","pat":"0","sl":"0","sd":"0","rh":"0"},"leaves_2026":{"el_open":15}},
{"id":1767959835263,"name":"Dr.Jagtap Prajakta Sudhakar","desig":"Associate Professor","dept":"Panchakarma","code":"AYPK00359","doj":"2019-02-15","dob":"1991-08-18","leaves_2025":{"cl":"8","ml":"4","el_u":"5","lat":"159"},"leaves_2026":{"el_open":0}},
{"id":1767957913565,"name":"Dr.Snehal Gunderao Patil","desig":"Associate Professor","dept":"Kayachikitsa","code":"AYKC01011","doj":"2019-02-22","dob":"1986-04-04","leaves_2025":{"cl":"6","ml":"1","el_u":"1","lat":"117","od":"0","mat":"0","pat":"0","sl":"0"},"leaves_2026":{"el_open":8}},
{"id":1767961462063,"name":"Dr.Surnar Yogeshwar Namdev","desig":"Associate Professor","dept":"Shalyatantra","code":"AYUST1442","doj":"2019-03-01","dob":"1989-11-25","leaves_2025":{"cl":"8","ml":"6","od":"1","el_u":"6","lat":"96"},"leaves_2026":{"el_open":0}},
{"id":1768021176843,"name":"Dr.Deepika Chandrakant Bhadre","desig":"Associate Professor","dept":"PTSR","code":"AYPS01057","doj":"2020-02-17","dob":"","leaves_2025":{"cl":"8","ml":"8","sl":"3","lat":"190"},"leaves_2026":{"el_open":15}},
{"id":1767960762214,"name":"Dr.Ghorband Shital Dattatray","desig":"Associate Professor","dept":"Dravayaguna Vidnyan","code":"AYDG","doj":"2020-03-13","dob":"1981-02-23","leaves_2025":{"cl":"8","ml":"10","od":"9","el_u":"15","lat":"146","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0"},"leaves_2026":{"el_open":0}},
{"id":1768021168209,"name":"Dr.Prashant Tryambakrao Biradar","desig":"Assistant Professor","dept":"Sanskrit Samhita Siddhant","code":"AYSN00048","doj":"2012-02-06","dob":"","leaves_2025":{"lat":"102","cl":"8","ml":"2","od":"10","el_u":"5","mat":"0"},"leaves_2026":{"el_open":"","cl":"","ml":"","od":"","el_u":"","lat":""}},
{"id":1768021176627,"name":"Dr.Asmita Ashokrao Bhadre","desig":"Assistant Professor","dept":"Kaumarbhritya","code":"AYKB00709","doj":"2021-01-02","dob":"","leaves_2025":{"cl":"8","ml":"1","el_u":"4","lat":"171"},"leaves_2026":{"el_open":15}},
{"id":1767958840101,"name":"Dr.Martule Shivkumar Surykant","desig":"Assistant Professor","dept":"Kaumarbhritya","code":"AYKB00725","doj":"2021-03-25","dob":"1994-01-01","leaves_2025":{"lat":"141","cl":"8","od":"2","ml":"","el_u":"3"},"leaves_2026":{"el_open":"0"}},
{"id":1768203668172,"name":"Namrata Virnath Kore","desig":"Assistant Professor","dept":"Rognidan and Vikruti Vigyan","code":"AYRN00765","doj":"2021-03-26","dob":"","leaves_2025":{"lat":"248","mat":"0","ml":"10","lwp":"13","cl":"8","od":"3","el_u":"7","pat":"0","sl":"0","sd":"0","rh":"0"},"leaves_2026":{}},
{"id":1,"name":"Dr. Jadhav Vishnukant Rameshrao","desig":"Assistant Professor","dept":"Rachana Sharir","code":"AYRS01211","doj":"2022-04-01","dob":"1994-02-13","leaves_2025":{"lat":"116","sl":"0","cl":"8","ml":"0","el_u":"0","rh":"0"},"leaves_2026":{"el_open":8}},
{"id":1768021164259,"name":"Dr.Pravin Dattatraya Balutkar","desig":"Assistant Professor","dept":"RSBK","code":"AYRB01770","doj":"2022-04-01","dob":"1985-02-02","leaves_2025":{"cl":"8","ml":"10","od":"2","el_u":"11","lat":"124"},"leaves_2026":{"el_open":0}},
{"id":1767960145014,"name":"Dr.Soppa Madhumati Shrikant","desig":"Assistant Professor","dept":"Kriya Sharir","code":"AYKS01029","doj":"2022-06-20","dob":"1989-10-10","leaves_2025":{"cl":"6","ml":"8","od":"3","lat":"153"},"leaves_2026":{"el_open":0}},
{"id":1768021168426,"name":"Dr.Amol Shivajirao Patil","desig":"Assistant Professor","dept":"Shalya tantra","code":"AYST02412","doj":"2024-01-19","dob":"","leaves_2025":{"cl":"8","ml":"6","od":"0","el_u":"5","lat":"148","mat":"","pat":"5"},"leaves_2026":{"el_open":"0","cl":"8","ml":"6","od":"0","el_u":"5","lat":"148","pat":"5"}},
{"id":1767957277181,"name":"Dr.Shruti Rameshchandra Tiwari","desig":"Assistant Professor","dept":"Panchakarma","code":"AYPK94915","doj":"2024-06-01","dob":"1986-08-18","leaves_2025":{"cl":"8","ml":"8","od":"","el_u":"2","lat":"118","rh":"0"},"leaves_2026":{"el_open":0}},
{"id":1767958307517,"name":"Dr.Meera Shankarrao Kadam","desig":"Assistant Professor","dept":"Agadtantra evum VV","code":"AYAT00650","doj":"2024-08-04","dob":"1991-05-03","leaves_2025":{"od":"","cl":"8","ml":"4","el_u":"7","lat":"130","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0"},"leaves_2026":{"el_open":0}},
{"id":1767961700895,"name":"Dr.Shivpratap Vinayak Biradar","desig":"Assistant Professor","dept":"Kaumarbhritya","code":"AYKB01247","doj":"2025-04-07","dob":"1995-06-11","leaves_2025":{"cl":"5","lat":"113"},"leaves_2026":{"el_open":12}},
{"id":1768048121381,"name":"Dr.Raghini Ramrao Navatke","desig":"Assistant Professor","dept":"Kayachikitsa","code":"AYKC04182","doj":"2025-04-23","dob":"","leaves_2025":{"lat":"45","mat":"20","pat":"0","sl":"0","sd":"0","rh":"0","cl":"6","ml":"0","od":"0","el_u":"0"},"leaves_2026":{}},
{"id":1767960539895,"name":"Dr.Madhuri Suryakant Biradar","desig":"Assistant Professor","dept":"Shalyatntra","code":"AYST02720","doj":"2025-05-17","dob":"1997-06-01","leaves_2025":{"cl":"7","el_u":"0","lat":"90","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0","lwp":"0"},"leaves_2026":{"el_open":13}},
{"id":1767957034325,"name":"Dr.Bharkade Jayshree Govindrao","desig":"Assistant Professor","dept":"Agadtantra evum VV","code":"AYAT00917","doj":"2025-05-23","dob":"1994-04-14","leaves_2025":{"lat":"86","cl":"8","ml":"2"},"leaves_2026":{"el_open":11}},
{"id":1768047235877,"name":"Dr.Ketki Rangnath Tarde","desig":"Assistant Professor","dept":"Sanskrit Samhita Siddhant","code":"AYSS02196","doj":"2025-05-24","dob":"","leaves_2025":{"cl":"4","ml":"72","od":"0","el_u":"0","lat":"17","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0","lwp":"0"},"leaves_2026":{}},
{"id":1767956778629,"name":"Dr.Shivani Tanajirao Patil","desig":"Assistant Professor","dept":"Sanskrit Samhita Siddhant","code":"AYSS02244","doj":"2025-06-04","dob":"1996-08-26","leaves_2025":{"cl":"6.5","lat":"69","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0","lwp":"0"},"leaves_2026":{"el_open":15}},
{"id":1768047609764,"name":"Dr.Swapnil Janardhan Biradar Patil","desig":"Assistant Professor","dept":"Kriya Sharir","code":"AYKS01398","doj":"2025-06-12","dob":"","leaves_2025":{"cl":"7","ml":"1","lat":"61","mat":"0","el_u":"0","od":"0","pat":"0","sl":"0","sd":"0","rh":"0"},"leaves_2026":{}},
{"id":1768370893500,"name":"Suraj Damodar Lavate","desig":"Assistant Professor","dept":"Shalakya tantra","code":"AYSK01446","doj":"2025-06-13","dob":"","leaves_2025":{},"leaves_2026":{}},
{"id":1767959185758,"name":"Dr.Biradar Mallikarjun Vishwanath","desig":"Assistant Professor","dept":"Agadtantra evum VV","code":"AYAT00926","doj":"2025-08-06","dob":"1966-09-01","leaves_2025":{"cl":"8","el_u":"8","lat":"79","mat":"0","pat":"0","sl":"0","sd":"0","rh":"0","lwp":"0"},"leaves_2026":{"el_open":6}},
{"id":1768021175130,"name":"Dr.Priyanka Dnyanoba Devkatte","desig":"Assistant Professor","dept":"PTSR","code":"AYPS01975","doj":"2025-12-15","dob":"","leaves_2025":{"lat":"8","mat":"0","pat":"0","sl":"1","sd":"0","rh":"0","lwp":"0"},"leaves_2026":{"el_open":15}},
{"id":1768370845124,"name":"Shivraj Shriram Vansure","desig":"Assistant Professor","dept":"Shalakya tantra","code":"AYSK01538","doj":"2025-12-15","dob":"","leaves_2025":{},"leaves_2026":{}},
{"id":1768370366020,"name":"Deepali Sanjay Kulkarni","desig":"Assistant Professor","dept":"","code":"","doj":"","dob":"","leaves_2025":{},"leaves_2026":{}},
{"id":1768021173515,"name":"Dr.Chetlure Shivkanta Laxman","desig":"Assistant Professor","dept":"Kayachikitsa","code":"","doj":"","dob":"","leaves_2025":{},"leaves_2026":{"el_open":15}},
{"id":1768370657534,"name":"Swapnil Janardhan Biradar Patil","desig":"Assistant Professor","dept":"Kriya Sharir","code":"","doj":"","dob":"","leaves_2025":{},"leaves_2026":{}}
];

/* ===== INIT ===== */
window.onload = function() {
    var today = new Date();
    document.getElementById('reportDate').value = today.toLocaleDateString('en-GB');

    // Load data
    var local = localStorage.getItem('damch_data_v25');
    if(local) { data = JSON.parse(local); }
    else { data = JSON.parse(JSON.stringify(DEFAULT_DATA)); }

    // Load users
    var uLocal = localStorage.getItem('damch_users_v25');
    if(uLocal) { users = JSON.parse(uLocal); }
    else { buildDefaultUsers(); }

    // Load logo
    var logo = localStorage.getItem('damch_logo');
    if(logo) {
        document.getElementById('logoImg').src = logo; document.getElementById('logoImg').style.display = 'block'; document.getElementById('logoTxt').style.display = 'none';
        document.getElementById('loginLogoImg').src = logo; document.getElementById('loginLogoImg').style.display = 'block'; document.getElementById('loginLogoTxt').style.display = 'none';
    }

    // Check session
    var sess = sessionStorage.getItem('damch_session');
    if(sess) { currentUser = JSON.parse(sess); showApp(); }

    document.getElementById('loginPass').addEventListener('keypress', function(e) { if(e.key === 'Enter') doLogin(); });
    document.getElementById('loginUser').addEventListener('keypress', function(e) { if(e.key === 'Enter') document.getElementById('loginPass').focus(); });
};

function buildDefaultUsers() {
    users = {};
    users['admin'] = { pw: 'Admin@2025', role: 'admin', facultyId: null };
    data.forEach(function(r) {
        var code = (r.code || '').trim();
        if(code && code.length > 2) {
            users[code] = { pw: 'damch@' + code, role: 'faculty', facultyId: r.id };
        }
    });
    localStorage.setItem('damch_users_v25', JSON.stringify(users));
}

/* ===== LOGIN / LOGOUT ===== */
function togglePw() {
    var f = document.getElementById('loginPass');
    var s = f.previousElementSibling ? document.querySelector('.toggle-pw') : null;
    if(f.type === 'password') { f.type = 'text'; document.querySelector('.toggle-pw').textContent = 'Hide Password'; }
    else { f.type = 'password'; document.querySelector('.toggle-pw').textContent = 'Show Password'; }
}

function doLogin() {
    var u = document.getElementById('loginUser').value.trim();
    var p = document.getElementById('loginPass').value;
    var msg = document.getElementById('loginMsg');

    if(!u || !p) { msg.textContent = 'Please enter username and password.'; return; }
    if(!users[u]) { msg.textContent = 'Invalid username.'; return; }
    if(users[u].pw !== p) { msg.textContent = 'Incorrect password.'; return; }

    currentUser = { username: u, role: users[u].role, facultyId: users[u].facultyId };
    sessionStorage.setItem('damch_session', JSON.stringify(currentUser));
    msg.textContent = '';
    showApp();
}

function doLogout() {
    sessionStorage.removeItem('damch_session');
    currentUser = null;
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
}

function showApp() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';

    var isAdmin = currentUser.role === 'admin';
    document.getElementById('dispUserName').textContent = isAdmin ? 'Administrator' : currentUser.username;
    document.getElementById('dispUserRole').textContent = isAdmin ? 'Role: Admin' : 'Role: Faculty';

    // Show/hide admin features
    document.getElementById('adminPanel').style.display = isAdmin ? 'flex' : 'none';
    document.getElementById('adminBtns').style.display = isAdmin ? 'inline' : 'none';
    document.getElementById('actionColHead').style.display = isAdmin ? '' : 'none';

    render();
}

/* ===== PROFILE ===== */
function openProfile() {
    if(currentUser.role === 'admin') { alert('Admin profile: Username=admin. Use this panel to manage all faculty.'); return; }
    var row = data.find(function(r) { return r.id === currentUser.facultyId; });
    if(!row) { alert('Profile not found.'); return; }

    document.getElementById('pf_name').value = row.name || '';
    document.getElementById('pf_desig').value = row.desig || '';
    document.getElementById('pf_dept').value = row.dept || '';
    document.getElementById('pf_code').value = row.code || '';

    // DOJ
    if(row.doj) {
        var d = new Date(row.doj);
        if(!isNaN(d)) {
            document.getElementById('pf_doj_dd').value = String(d.getDate()).padStart(2,'0');
            document.getElementById('pf_doj_mm').value = String(d.getMonth()+1).padStart(2,'0');
            document.getElementById('pf_doj_yyyy').value = d.getFullYear();
        }
    } else { document.getElementById('pf_doj_dd').value=''; document.getElementById('pf_doj_mm').value=''; document.getElementById('pf_doj_yyyy').value=''; }

    // DOB
    if(row.dob) {
        var b = new Date(row.dob);
        if(!isNaN(b)) {
            document.getElementById('pf_dob_dd').value = String(b.getDate()).padStart(2,'0');
            document.getElementById('pf_dob_mm').value = String(b.getMonth()+1).padStart(2,'0');
            document.getElementById('pf_dob_yyyy').value = b.getFullYear();
        }
    } else { document.getElementById('pf_dob_dd').value=''; document.getElementById('pf_dob_mm').value=''; document.getElementById('pf_dob_yyyy').value=''; }

    document.getElementById('pf_newpw').value = '';
    document.getElementById('profileModal').classList.add('active');
}

function closeProfile() { document.getElementById('profileModal').classList.remove('active'); }

function autoTab(el, nextId) {
    if(el.value.length >= parseInt(el.maxLength)) { document.getElementById(nextId).focus(); }
}

function saveProfile() {
    var row = data.find(function(r) { return r.id === currentUser.facultyId; });
    if(!row) return;

    // Parse DOJ
    var dj_dd = document.getElementById('pf_doj_dd').value.trim();
    var dj_mm = document.getElementById('pf_doj_mm').value.trim();
    var dj_yy = document.getElementById('pf_doj_yyyy').value.trim();
    if(dj_dd && dj_mm && dj_yy) {
        var djDate = new Date(dj_yy, parseInt(dj_mm)-1, parseInt(dj_dd));
        if(!isNaN(djDate)) { row.doj = dj_yy + '-' + dj_mm.padStart(2,'0') + '-' + dj_dd.padStart(2,'0'); }
    }

    // Parse DOB
    var db_dd = document.getElementById('pf_dob_dd').value.trim();
    var db_mm = document.getElementById('pf_dob_mm').value.trim();
    var db_yy = document.getElementById('pf_dob_yyyy').value.trim();
    if(db_dd && db_mm && db_yy) {
        var dbDate = new Date(db_yy, parseInt(db_mm)-1, parseInt(db_dd));
        if(!isNaN(dbDate)) { row.dob = db_yy + '-' + db_mm.padStart(2,'0') + '-' + db_dd.padStart(2,'0'); }
    }

    // Password change
    var newPw = document.getElementById('pf_newpw').value;
    if(newPw && newPw.length >= 4) {
        users[currentUser.username].pw = newPw;
        localStorage.setItem('damch_users_v25', JSON.stringify(users));
    }

    save();
    render();
    closeProfile();
    alert('Profile updated successfully!');
}
/* ===== EXPERIENCE CALC ===== */
function calcExp(dojStr) {
    if(!dojStr) return "Exp: -";
    var doj = new Date(dojStr);
    if(isNaN(doj)) return "Exp: -";
    var rptDateVal = document.getElementById('reportDate').value;
    var now = new Date();
    if(rptDateVal) { var parts = rptDateVal.split('/'); if(parts.length===3) now = new Date(parts[2], parts[1]-1, parts[0]); }
    var years = now.getFullYear() - doj.getFullYear();
    var months = now.getMonth() - doj.getMonth();
    var days = now.getDate() - doj.getDate();
    if(days < 0) { months--; var pm = new Date(now.getFullYear(), now.getMonth(), 0); days += pm.getDate(); }
    if(months < 0) { years--; months += 12; }
    if(years < 0) return "Exp: 0";
    return years + "Y " + months + "M " + days + "D";
}

function formatDateDDMMYYYY(isoStr) {
    if(!isoStr) return '';
    var d = new Date(isoStr);
    if(isNaN(d)) return '';
    return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
}

/* ===== SORT ===== */
function sortData() {
    data.sort(function(a, b) {
        var dA = (a.desig || "").toUpperCase().trim();
        var dB = (b.desig || "").toUpperCase().trim();
        var rA = desigRank[dA] || 99;
        var rB = desigRank[dB] || 99;
        if(rA !== rB) return rA - rB;
        var dateA = a.doj ? new Date(a.doj) : new Date('9999-12-31');
        var dateB = b.doj ? new Date(b.doj) : new Date('9999-12-31');
        if(dateA.getTime() !== dateB.getTime()) return dateA - dateB;
        return (a.name || "").localeCompare(b.name || "");
    });
}

/* ===== CALC ROW ===== */
function calcRow(row, year) {
    var l = row['leaves_' + year] || {};
    var v = function(k) { return parseFloat(l[k]) || 0; };
    var cl_bal = 8 - v('cl');
    var ml_bal = 10 - v('ml');
    var rh_bal = 2 - v('rh');
    var mat_bal = 180 - v('mat');
    var pat_bal = 15 - v('pat');
    var sl_bal = 15 - v('sl');
    var sd_bal = 120 - v('sd');
    var el_open = parseFloat(l.el_open) || 0;
    var el_tot_avail = el_open + 15;
    var el_bal = el_tot_avail - v('el_u');
    var late_cnt = v('lat');
    var late_ded = Math.floor(late_cnt / 6);
    var paid_buffer = cl_bal + el_bal + ml_bal + rh_bal;
    if(paid_buffer < 0) paid_buffer = 0;
    var covered = 0, overflow = 0;
    if(late_ded <= paid_buffer) { covered = late_ded; } else { covered = paid_buffer; overflow = late_ded - paid_buffer; }
    var tot_paid = v('cl') + v('ml') + v('od') + v('el_u') + v('mat') + v('pat') + v('sl') + v('sd') + v('rh') + covered;
    var tot_unp = v('lwp') + overflow;
    var grand_tot = tot_paid + tot_unp;
    var lwp_display = v('lwp') + overflow;
    return { cl_bal:cl_bal, ml_bal:ml_bal, rh_bal:rh_bal, mat_bal:mat_bal, pat_bal:pat_bal, sl_bal:sl_bal, sd_bal:sd_bal, el_open:el_open, el_tot_avail:el_tot_avail, el_bal:el_bal, late_ded:late_ded, overflow:overflow, tot_paid:tot_paid, tot_unp:tot_unp, grand_tot:grand_tot, lwp_display:lwp_display, v:v };
}

/* ===== RENDER ===== */
function render() {
    sortData();
    var tb = document.getElementById('tbody');
    tb.innerHTML = '';
    var isAdmin = currentUser && currentUser.role === 'admin';

    data.forEach(function(row, i) {
        var res = calcRow(row, curYr);
        var l = row['leaves_' + curYr] || {};
        var expStr = calcExp(row.doj);
        var openELVal = l.el_open !== undefined ? l.el_open : 0;
        var dojDisplay = formatDateDDMMYYYY(row.doj);
        var dobDisplay = formatDateDDMMYYYY(row.dob);

        var canEdit = isAdmin;
        var readonlyAttr = canEdit ? '' : 'readonly style="background:#f5f5f5; cursor:not-allowed;"';
        var disabledNum = canEdit ? '' : 'readonly style="background:#f5f5f5; cursor:not-allowed; width:35px; text-align:center; border:1px solid #333; font-weight:bold; font-size:12px; padding:2px;"';

        var tr = '<td class="col-fix">' + (i+1) + '</td>';
        tr += '<td class="col-fix-2">';
        if(canEdit) {
            tr += '<input type="text" value="' + (row.name||'') + '" onchange="updMeta(' + row.id + ',\'name\',this.value)" placeholder="Name" style="font-weight:bold;">';
            tr += '<input type="text" value="' + (row.desig||'') + '" onchange="updMeta(' + row.id + ',\'desig\',this.value)" placeholder="Designation" list="desigList">';
            tr += '<input type="text" value="' + (row.dept||'') + '" onchange="updMeta(' + row.id + ',\'dept\',this.value)" placeholder="Department">';
            tr += '<div style="display:flex; gap:2px; margin-top:2px;">';
            tr += '<div><span class="info-label">Code</span><input type="text" value="' + (row.code||'') + '" onchange="updMeta(' + row.id + ',\'code\',this.value)" style="width:55px;"></div>';
            tr += '<div><span class="info-label">DOJ</span><input type="date" value="' + (row.doj||'') + '" onchange="updMeta(' + row.id + ',\'doj\',this.value)" style="width:75px;"></div>';
            tr += '<div><span class="info-label">DOB</span><input type="date" value="' + (row.dob||'') + '" onchange="updMeta(' + row.id + ',\'dob\',this.value)" style="width:75px;"></div>';
            tr += '</div>';
        } else {
            tr += '<div style="font-weight:bold; font-size:12px;">' + (row.name||'') + '</div>';
            tr += '<div style="font-size:10px; color:#555;">' + (row.desig||'') + ' | ' + (row.dept||'') + '</div>';
            tr += '<div style="font-size:9px; color:#333;">Code: ' + (row.code||'-') + ' | DOJ: ' + (dojDisplay||'-') + ' | DOB: ' + (dobDisplay||'-') + '</div>';
        }
        tr += '<div class="exp-tag">' + expStr + '</div>';
        tr += '</td>';

        // Leave cells
        if(canEdit) {
            tr += '<td><input type="number" value="' + (l.cl||'') + '" onchange="upd(' + row.id + ',\'cl\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.cl_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.ml||'') + '" onchange="upd(' + row.id + ',\'ml\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.ml_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.od||'') + '" onchange="upd(' + row.id + ',\'od\',this.value)"></td>';
            tr += '<td><input type="number" value="' + openELVal + '" onchange="upd(' + row.id + ',\'el_open\',this.value)" style="background:#e3f2fd; width:30px;"></td>';
            tr += '<td class="bg-bal">15</td>';
            tr += '<td class="bg-bal">' + res.el_tot_avail + '</td>';
            tr += '<td><input type="number" value="' + (l.el_u||'') + '" onchange="upd(' + row.id + ',\'el_u\',this.value)"></td>';
            tr += '<td class="bg-bal" style="background:#bbdefb; border:1px solid #1565c0;">' + res.el_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.lat||'') + '" onchange="upd(' + row.id + ',\'lat\',this.value)"></td>';
            tr += '<td class="bg-bal-neg" style="color:#d32f2f;">' + res.late_ded + '</td>';
            tr += '<td><input type="number" value="' + (l.mat||'') + '" onchange="upd(' + row.id + ',\'mat\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.mat_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.pat||'') + '" onchange="upd(' + row.id + ',\'pat\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.pat_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.sl||'') + '" onchange="upd(' + row.id + ',\'sl\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.sl_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.sd||'') + '" onchange="upd(' + row.id + ',\'sd\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.sd_bal + '</td>';
            tr += '<td><input type="number" value="' + (l.rh||'') + '" onchange="upd(' + row.id + ',\'rh\',this.value)"></td>';
            tr += '<td class="bg-bal">' + res.rh_bal + '</td>';
        } else {
            // Read-only for faculty
            tr += '<td class="bg-bal">' + (parseFloat(l.cl)||0) + '</td><td class="bg-bal">' + res.cl_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.ml)||0) + '</td><td class="bg-bal">' + res.ml_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.od)||0) + '</td>';
            tr += '<td class="bg-bal">' + openELVal + '</td><td class="bg-bal">15</td><td class="bg-bal">' + res.el_tot_avail + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.el_u)||0) + '</td>';
            tr += '<td class="bg-bal" style="background:#bbdefb;">' + res.el_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.lat)||0) + '</td><td class="bg-bal-neg">' + res.late_ded + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.mat)||0) + '</td><td class="bg-bal">' + res.mat_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.pat)||0) + '</td><td class="bg-bal">' + res.pat_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.sl)||0) + '</td><td class="bg-bal">' + res.sl_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.sd)||0) + '</td><td class="bg-bal">' + res.sd_bal + '</td>';
            tr += '<td class="bg-bal">' + (parseFloat(l.rh)||0) + '</td><td class="bg-bal">' + res.rh_bal + '</td>';
        }

        tr += '<td class="tot-paid-cell">' + res.tot_paid + '</td>';

        if(canEdit) {
            tr += '<td><input type="number" value="' + (l.lwp||'') + '" onchange="upd(' + row.id + ',\'lwp\',this.value)">';
            if(res.overflow > 0) tr += '<div style="font-size:8px; color:red; font-weight:bold">(+' + res.overflow + ')</div>';
            tr += '</td>';
        } else {
            tr += '<td class="bg-bal">' + res.lwp_display + '</td>';
        }

        tr += '<td class="tot-unpaid-cell">' + res.tot_unp + '</td>';
        tr += '<td class="grand-tot-cell">' + res.grand_tot + '</td>';

        if(isAdmin) {
            tr += '<td><button class="btn btn-del" onclick="delRow(' + row.id + ')">Del</button></td>';
        }

        var trEl = document.createElement('tr');
        trEl.innerHTML = tr;
        tb.appendChild(trEl);
    });
}

/* ===== CARRY FORWARD ===== */
function calculateCarryForward() {
    if(!confirm("Calculate 2026 Opening EL from 2025 usage?\nThis will overwrite 'Open' EL in 2026.")) return;
    data.forEach(function(r) {
        var res25 = calcRow(r, '2025');
        var penalty = res25.late_ded;
        var others_avail = res25.cl_bal + res25.ml_bal + res25.rh_bal;
        var penalty_eating_el = 0;
        if(penalty > others_avail) penalty_eating_el = penalty - others_avail;
        var actual_el_left = res25.el_bal - penalty_eating_el;
        if(actual_el_left < 0) actual_el_left = 0;
        if(!r.leaves_2026) r.leaves_2026 = {};
        r.leaves_2026.el_open = actual_el_left;
    });
    alert("Done! Switched to 2026.");
    swYear('2026');
    save();
}
/* ===== REPORTS ===== */
function searchFaculty() {
    var name = prompt("Enter Name to Search:");
    if(!name) return;
    var found = data.find(function(r) { return r.name.toLowerCase().indexOf(name.toLowerCase()) !== -1; });
    if(found) genIndividualReport(null, found.id); else alert("Not found.");
}
function askDetailedDeptReport() { var d = prompt("Enter Department:"); if(d !== null) genIndividualReport(d.trim(), null); }
function askDeptReport() { var d = prompt("Enter Department:"); if(d !== null) genMasterReport(d.trim()); }

function genIndividualReport(filterDept, filterId) {
    var pSec = document.getElementById('printSection');
    var h = getPrintHeader();
    if(filterId) h += '<h4 style="text-align:center; margin:5px 0;">INDIVIDUAL FACULTY LEAVE RECORD</h4>';
    else if(filterDept) h += '<h4 style="text-align:center; margin:5px 0;">DETAILED DEPT: ' + filterDept.toUpperCase() + '</h4>';
    else h += '<h4 style="text-align:center; margin:5px 0;">ALL FACULTY DETAILED REPORT</h4>';
    var found = false;
    data.forEach(function(r) {
        if(filterId && r.id !== filterId) return;
        if(filterDept && (r.dept||"").toUpperCase().trim() !== filterDept.toUpperCase()) return;
        found = true;
        var res = calcRow(r, curYr);
        var v = function(k) { return parseFloat((r['leaves_' + curYr]||{})[k]) || 0; };
        var expStr = calcExp(r.doj);
        h += '<div class="ind-card"><div class="ind-header"><span class="ind-title">' + r.name + '</span><span style="font-weight:bold;">' + curYr + '</span></div>';
        h += '<div class="ind-meta"><div><b>Desig:</b> ' + r.desig + '</div><div><b>Dept:</b> ' + r.dept + '</div><div><b>Code:</b> ' + r.code + '</div><div><b>Exp:</b> ' + expStr + '</div></div>';
        h += '<div class="ind-sect-title">PAID LEAVES</div>';
        h += '<table class="ind-table"><thead><tr><th>Type</th><th>Limit</th><th>Used</th><th>Bal</th><th>Type</th><th>Limit</th><th>Used</th><th>Bal</th></tr></thead><tbody>';
        h += '<tr><td>CL</td><td>8</td><td>' + v('cl') + '</td><td>' + res.cl_bal + '</td><td>ML</td><td>10</td><td>' + v('ml') + '</td><td>' + res.ml_bal + '</td></tr>';
        h += '<tr><td>EL(Op:' + res.el_open + '+15)</td><td>' + res.el_tot_avail + '</td><td>' + v('el_u') + '</td><td>' + res.el_bal + '</td><td>SL</td><td>15</td><td>' + v('sl') + '</td><td>' + res.sl_bal + '</td></tr>';
        h += '<tr><td>Mat</td><td>180</td><td>' + v('mat') + '</td><td>' + res.mat_bal + '</td><td>Pat</td><td>15</td><td>' + v('pat') + '</td><td>' + res.pat_bal + '</td></tr>';
        h += '<tr><td>RH</td><td>2</td><td>' + v('rh') + '</td><td>' + res.rh_bal + '</td><td>OD</td><td>-</td><td>' + v('od') + '</td><td>-</td></tr>';
        h += '</tbody></table>';
        h += '<div class="ind-sect-title">LATE PENALTY (1/6)</div>';
        h += '<table class="ind-table"><tr><td>Late: <b style="color:red">' + v('lat') + '</b></td><td>Penalty: <b style="color:red">' + res.late_ded + '</b></td><td>â†’ LWP: <b style="color:red">' + res.overflow + '</b></td></tr></table>';
        h += '<div class="ind-summary"><span>PAID: ' + res.tot_paid + '</span><span style="color:#b71c1c;">UNPAID: ' + res.tot_unp + '</span><span style="background:yellow; padding:0 5px;">TOTAL: ' + res.grand_tot + '</span></div></div>';
    });
    if(!found) { alert("No faculty found."); return; }
    h += '<div class="print-footer">Designed & Developed by Dr. Jadhav V.R. | Contact: 9518356305</div>';
    pSec.innerHTML = h;
    window.print();
}

function genMasterReport(filterDept) {
    var pSec = document.getElementById('printSection');
    var h = getPrintHeader();
    var title = filterDept ? 'DEPT SUMMARY: ' + filterDept.toUpperCase() + ' (' + curYr + ')' : 'MASTER SUMMARY (' + curYr + ')';
    h += '<h4 style="text-align:center; text-decoration:underline; margin:5px 0;">' + title + '</h4>';
    var groups = {};
    data.forEach(function(r) {
        var d = (r.dept || "Other").toUpperCase().trim();
        if(filterDept && d !== filterDept.toUpperCase()) return;
        if(!groups[d]) groups[d] = [];
        groups[d].push(r);
    });
    var depts = Object.keys(groups).sort();
    if(!depts.length) { alert("No faculty found."); return; }
    depts.forEach(function(d) {
        h += '<div class="dept-head">DEPARTMENT: ' + d + '</div>';
        h += '<table class="rpt-table"><thead><tr><th style="width:5%">Sr</th><th style="width:25%">Name</th><th>CL</th><th>ML</th><th>EL</th><th>OD</th><th>RH</th><th>SL</th><th>Mat</th><th>Pat</th><th>Lat</th><th>LWP</th><th>Tot</th></tr></thead><tbody>';
        groups[d].forEach(function(r, idx) {
            var res = calcRow(r, curYr);
            var v = function(k) { return parseFloat((r['leaves_' + curYr]||{})[k]) || 0; };
            h += '<tr><td>' + (idx+1) + '</td><td style="text-align:left"><b>' + r.name + '</b></td>';
            h += '<td>' + res.cl_bal + '</td><td>' + res.ml_bal + '</td><td>' + res.el_bal + '</td><td>' + v('od') + '</td>';
            h += '<td>' + res.rh_bal + '</td><td>' + res.sl_bal + '</td><td>' + res.mat_bal + '</td><td>' + res.pat_bal + '</td>';
            h += '<td>' + res.late_ded + '</td><td>' + res.lwp_display + '</td><td><b>' + res.grand_tot + '</b></td></tr>';
        });
        h += '</tbody></table>';
    });
    h += '<div class="print-footer">Designed & Developed by Dr. Jadhav V.R. | Contact: 9518356305</div>';
    pSec.innerHTML = h;
    window.print();
}

function getPrintHeader() {
    var tVal = document.getElementById('tHead').innerText;
    var cVal = document.getElementById('cHead').innerText;
    var aVal = document.getElementById('cAddr').innerText;
    var logoSrc = document.getElementById('logoImg').src;
    var logoDisp = document.getElementById('logoImg').style.display !== 'none' ? '<img src="' + logoSrc + '">' : '';
    var dVal = document.getElementById('reportDate').value;
    return '<div class="rpt-header"><div class="rpt-logo">' + logoDisp + '</div><div class="rpt-titles"><h3>' + tVal + '</h3><h2>' + cVal + '</h2><h5>' + aVal + '</h5></div><div style="font-size:10px; font-weight:bold; width:80px; text-align:right;">Date: ' + dVal + '</div></div>';
}

/* ===== UTILS ===== */
function upd(id, key, val) {
    var row = data.find(function(r) { return r.id === id; });
    if(!row['leaves_' + curYr]) row['leaves_' + curYr] = {};
    row['leaves_' + curYr][key] = val;
    save(); render();
}
function updMeta(id, key, val) {
    var row = data.find(function(r) { return r.id === id; });
    row[key] = val;
    // If code changed, update users
    if(key === 'code' && val && val.trim().length > 2) {
        var oldCode = Object.keys(users).find(function(u) { return users[u].facultyId === id && u !== 'admin'; });
        if(oldCode) delete users[oldCode];
        users[val.trim()] = { pw: 'damch@' + val.trim(), role: 'faculty', facultyId: id };
        localStorage.setItem('damch_users_v25', JSON.stringify(users));
    }
    save();
    if(key === 'desig' || key === 'doj') render();
}
function addRow() {
    data.push({ id: Date.now(), name: "", desig: "", dept: "", code: "", doj: "", dob: "", leaves_2025: {}, leaves_2026: {} });
    save(); render();
}
function delRow(id) {
    if(confirm('Delete this faculty?')) {
        data = data.filter(function(r) { return r.id !== id; });
        // Remove user
        var uKey = Object.keys(users).find(function(u) { return users[u].facultyId === id; });
        if(uKey) { delete users[uKey]; localStorage.setItem('damch_users_v25', JSON.stringify(users)); }
        save(); render();
    }
}
function swYear(y) {
    curYr = y;
    document.getElementById('btn25').className = y === '2025' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btn26').className = y === '2026' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('yrTitle').innerText = "Record: " + y;
    render();
}
function save() { localStorage.setItem('damch_data_v25', JSON.stringify(data)); }
function saveData() { save(); alert("Data saved to browser!"); }

function loadLogo(e) {
    var r = new FileReader();
    r.onload = function(ev) { localStorage.setItem('damch_logo', ev.target.result); location.reload(); };
    r.readAsDataURL(e.target.files[0]);
}
function downloadJSON() {
    var blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'DAMCH_Backup_' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function expCSV() {
    var csv = "Sr,Name,Desig,Dept,Code,DOJ,Experience,DOB,CL_Bal,ML_Bal,EL_Open,EL_Total,EL_Used,EL_Bal,OD,RH_Bal,SL_Bal,Mat_Bal,Pat_Bal,Late_Ded,LWP_Total,Grand_Total\n";
    data.forEach(function(r, i) {
        var res = calcRow(r, curYr);
        var v = function(k) { return parseFloat((r['leaves_' + curYr]||{})[k]) || 0; };
        var expStr = calcExp(r.doj).replace(/,/g, '');
        csv += (i+1) + ',"' + r.name + '","' + r.desig + '","' + (r.dept||'') + '","' + (r.code||'') + '","' + formatDateDDMMYYYY(r.doj) + '","' + expStr + '","' + formatDateDDMMYYYY(r.dob) + '",' + res.cl_bal + ',' + res.ml_bal + ',' + res.el_open + ',' + res.el_tot_avail + ',' + v('el_u') + ',' + res.el_bal + ',' + v('od') + ',' + res.rh_bal + ',' + res.sl_bal + ',' + res.mat_bal + ',' + res.pat_bal + ',' + res.late_ded + ',' + res.lwp_display + ',' + res.grand_tot + '\n';
    });
    var blob = new Blob([csv], { type: 'text/csv' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Leave_Report_' + curYr + '.csv';
    a.click();
}
function restData(e) {
    var r = new FileReader();
    r.onload = function(ev) {
        try { data = JSON.parse(ev.target.result); buildDefaultUsers(); save(); render(); alert("Data Restored!"); }
        catch(err) { alert("Invalid JSON file."); }
    };
    r.readAsText(e.target.files[0]);
}
</script>

<datalist id="desigList">
    <option value="Principal">
    <option value="Professor">
    <option value="Associate Professor">
    <option value="Assistant Professor">
</datalist>

</body>
</html>
